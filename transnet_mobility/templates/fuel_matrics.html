{% extends 'base.html' %}

{% block title %}Fuel Matrics{% endblock %}
{% block content %}
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .builder, .survey { margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; }
    .question { margin: 10px 0; }
    label { display: block; margin-bottom: 5px; }
    input, select, button, textarea { margin: 5px 0; }
  </style>
            <!-- Main Content -->
            <div class=" p-4">
                
                
                <div class="row">
                    <div class="col-md">
                        <div class="card ">
                            <div class="card-header">
                                <h5 class="card-title">Fuel Matrics</h5>
                            </div>
                            <div class="card-body">
                                <form id="fuelForm" method="post" action="">
                                  {% csrf_token %}
                                  <input type="hidden" name="selected_spec_id" value="" />

                                  <div class="mb-3">
                                    <label class="form-label">Select Locomotive *</label>
                                    <select class="form-select" name="locomotive_id" required>
                                      <option value="" disabled selected>Select locomotive...</option>
                                      {% if locomotives %}
                                        {% for loco in locomotives %}
                                          <option value="{{ loco.id }}">{{ loco.name }}</option>
                                        {% endfor %}
                                      {% else %}
                                        <option disabled>No locomotives assigned</option>
                                      {% endif %}
                                    </select>
                                  </div>

                                  <div class="mb-3">
                                    <label class="form-label">Select Saved Fuel Entry</label>
                                    <div class="input-group">
                                      <select class="form-select" name="fuel_select">
                                        <option value="" disabled selected>Select saved entry...</option>
                                        {% if fuels %}
                                          {% for f in fuels %}
                                            <option value="{{ f.id }}">{{ f.locomotive_name }} - {{ f.fuel_type }} — {{ f.daily_fuel_consumption }}</option>
                                          {% endfor %}
                                          <option disabled>──────────</option>
                                        {% endif %}
                                      </select>
                                      <button id="selectFuelBtn" class="btn btn-primary" type="button">Select</button>
                                    </div>
                                  </div>

                                  <div class="spec-item">
                                      <label class="form-label ">Daily Fuel Consumption</label>
                                      <input type="text" name="daily_fuel_consumption" class="form-control" placeholder="daily fuel consumption in L">
                                  </div>
                                
                                
                                <div class="spec-item">
                                    <label class="form-label">Fuel Cost Per Litre</label>
                  <input type="text" name="fuel_cost_per_litre" class="form-control" placeholder="Fuel Cost Per Litre (R)">
                                </div>
                                
                                <div class="spec-item">
                                    <label class="form-label">Average Load Per Trip</label>
                  <input type="text" name="average_load_per_trip" class="form-control" placeholder="Average Load Per Trip (tons)">
                                </div>
                                <div class="spec-item d-flex flex-column mb-3">
                                    <label class="form-label">Fuel Type</label>
                                    <select name="fuel_type" class="form-select">
                                      <option value="" selected disabled>select option</option>
                                      <option value="Diesel">Diesel</option>
                                      <option value="Petrol">Petrol</option>
                                      <option value="Bio-fuel">Bio-fuel</option>
                                      <option value="Electrical">Electrical</option>
                                    </select>
                                  </div>

                                  <!-- Dynamic survey fields will be injected here -->
                                  <div id="dynamicSurveyFields" class="mt-3"></div>
                                
                                
                            </div>
                        </div>
                    </div>

                    
                </div>

        <div class="d-flex justify-content-end mt-4 gap-2">
          <button type="reset" class="btn btn-outline-secondary">Cancel</button>
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
  </form>
  <!-- Saved fuels table -->
        <div class="row mt-4">
          <div class="col-md-12">
            <div class="card">
              <div class="card-header"><h5 class="card-title">Saved Fuel Entries</h5></div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-sm table-hover">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Locomotive</th>
                        <th>Fuel Type</th>
                        <th>Daily Consumption (L)</th>
                        <th>Cost Per L</th>
                        <th>Avg Load / Trip</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for f in fuels %}
                      <tr>
                        <td>{{ f.id }}</td>
                        <td>{{ f.locomotive_name|default:'' }}</td>
                        <td>{{ f.fuel_type|default:'' }}</td>
                        <td>{{ f.daily_fuel_consumption|default:'' }}</td>
                        <td>{{ f.fuel_cost_per_litre|default:'' }}</td>
                        <td>{{ f.average_load_per_trip|default:'' }}</td>
                        <td><button type="button" class="btn btn-sm btn-outline-primary edit-fuel-btn" data-id="{{ f.id }}">Edit</button></td>
                      </tr>
                      {% empty %}
                      <tr><td colspan="7">No saved fuel entries</td></tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
            </div>
        </div>
    </div>

  <!-- Question Builder (moved inside the page and tied to the fuel form) -->
  <div class="builder p-3 mt-4">
    <h5>Add Section</h5>
    <div class="mb-2">
      <label class="form-label">Question Text</label>
      <input class="form-control" type="text" id="questionText">
    </div>
    <div class="mb-2">
      <label class="form-label">Question Type</label>
      <select class="form-select" id="questionType">
        <option value="text">Short Text</option>
        <option value="textarea">Long Text</option>
        <option value="radio">Multiple Choice (Single)</option>
        <option value="checkbox">Multiple Choice (Multiple)</option>
        <option value="dropdown">Dropdown</option>
      </select>
    </div>
    <div class="mb-2">
      <label class="form-label">Options (comma separated, for radio/checkbox/dropdown)</label>
      <input class="form-control" type="text" id="options">
    </div>
    <div>
      <button class="btn btn-outline-dark" id="addQuestionBtn" type="button">Add Question</button>
    </div>
  </div>

  <script>
    // When a question is added, append a hidden survey_questions[] input and visible answer inputs
    function addQuestion() {
      const textEl = document.getElementById("questionText");
      const typeEl = document.getElementById("questionType");
      const optionsEl = document.getElementById("options");
      const text = textEl.value.trim();
      const type = typeEl.value;
      const options = optionsEl.value.split(',').map(o => o.trim()).filter(Boolean);

      if (!text) { alert('Please enter a question'); return; }

      const form = document.getElementById('fuelForm');
      const dynamic = document.getElementById('dynamicSurveyFields');

      // determine index for this question
      const idx = document.querySelectorAll('input[name="survey_questions[]"]').length;

      // create metadata hidden input
      const meta = { text: text, type: type, options: options };
      const hid = document.createElement('input');
      hid.type = 'hidden';
      hid.name = 'survey_questions[]';
      hid.value = JSON.stringify(meta);
      form.appendChild(hid);

      // create a visible wrapper for answers
      const wrap = document.createElement('div');
      wrap.className = 'mb-2';
      const lbl = document.createElement('label');
      lbl.className = 'form-label';
      lbl.textContent = text;
      wrap.appendChild(lbl);

      // create answer inputs depending on type
      if (type === 'text') {
        const a = document.createElement('input');
        a.type = 'text';
        a.name = `survey_answers[${idx}]`;
        a.className = 'form-control';
        wrap.appendChild(a);
      } else if (type === 'textarea') {
        const a = document.createElement('textarea');
        a.name = `survey_answers[${idx}]`;
        a.className = 'form-control';
        wrap.appendChild(a);
      } else if (type === 'radio') {
        options.forEach(opt => {
          const div = document.createElement('div');
          div.className = 'form-check';
          const i = document.createElement('input');
          i.type = 'radio';
          i.name = `survey_answers[${idx}]`;
          i.value = opt;
          i.className = 'form-check-input';
          const l = document.createElement('label');
          l.className = 'form-check-label';
          l.appendChild(document.createTextNode(opt));
          div.appendChild(i);
          div.appendChild(l);
          wrap.appendChild(div);
        });
      } else if (type === 'checkbox') {
        options.forEach(opt => {
          const div = document.createElement('div');
          div.className = 'form-check';
          const i = document.createElement('input');
          i.type = 'checkbox';
          i.name = `survey_answers[${idx}][]`;
          i.value = opt;
          i.className = 'form-check-input';
          const l = document.createElement('label');
          l.className = 'form-check-label';
          l.appendChild(document.createTextNode(opt));
          div.appendChild(i);
          div.appendChild(l);
          wrap.appendChild(div);
        });
      } else if (type === 'dropdown') {
        const s = document.createElement('select');
        s.name = `survey_answers[${idx}]`;
        s.className = 'form-select';
        const empty = document.createElement('option'); empty.value = ''; empty.textContent = 'Select...'; s.appendChild(empty);
        options.forEach(opt => {
          const o = document.createElement('option'); o.value = opt; o.textContent = opt; s.appendChild(o);
        });
        wrap.appendChild(s);
      }

      dynamic.appendChild(wrap);

      // reset builder fields
      textEl.value = '';
      optionsEl.value = '';
      typeEl.selectedIndex = 0;
    }

    document.getElementById('addQuestionBtn').addEventListener('click', addQuestion);
  </script>
    <script>
      (function(){
        const sel = document.querySelector('select[name="fuel_select"]');
        const btn = document.getElementById('selectFuelBtn');
        const endpoint = "{% url 'api_get_fuel_spec' %}";
        function fetchFuelById(id){
          if (!id) return;
          fetch(endpoint + '?id=' + encodeURIComponent(id))
            .then(r => { if (r.status === 204) return null; return r.json(); })
            .then(data => {
              if (!data) return;
              const set = (n,v) => { const el = document.querySelector('[name="'+n+'"]'); if (el) el.value = v || ''; };
              const selIdEl = document.querySelector('[name="selected_spec_id"]'); if (selIdEl) selIdEl.value = data.id || '';
              set('locomotive_id', data.locomotive_id);
              set('daily_fuel_consumption', data.daily_fuel_consumption);
              set('fuel_cost_per_litre', data.fuel_cost_per_litre);
              set('average_load_per_trip', data.average_load_per_trip);
              set('fuel_type', data.fuel_type);
            }).catch(err => console.warn('fuel fetch', err));
        }
        if (sel) sel.addEventListener('change', () => fetchFuelById(sel.value));
        if (btn) btn.addEventListener('click', () => fetchFuelById(sel.value));

        document.querySelectorAll('.edit-fuel-btn').forEach(b => {
          b.addEventListener('click', (e) => {
            const id = e.currentTarget.getAttribute('data-id');
            if (!id) return;
            fetchFuelById(id);
            if (sel) sel.value = id;
            const form = document.getElementById('fuelForm');
            if (form) form.scrollIntoView({ behavior: 'smooth', block: 'start' });
          });
        });
      })();
    </script>
    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    {% endblock %}