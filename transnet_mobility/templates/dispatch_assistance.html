{% extends 'base.html' %}
{% load static %}

{% block title %}Dispatch Assistance - Transnet Mobility{% endblock %}

{% block content %}
<style>
    .dispatch-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .dispatch-header {
        background: linear-gradient(135deg, #E31937 0%, #a10d00 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 4px 12px rgba(227, 25, 55, 0.3);
    }
    
    .dispatch-header h1 {
        margin: 0 0 10px 0;
        font-size: 32px;
    }
    
    .dispatch-header p {
        margin: 0;
        opacity: 0.9;
    }
    
    .request-details-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .request-details-card h2 {
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #E31937;
    }
    
    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .detail-item {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #E31937;
    }
    
    .detail-item label {
        font-weight: 600;
        color: #666;
        font-size: 13px;
        display: block;
        margin-bottom: 5px;
        text-transform: uppercase;
    }
    
    .detail-item .value {
        color: #333;
        font-size: 16px;
    }
    
    .issue-description {
        background: #fff3cd;
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #ffc107;
        margin-bottom: 20px;
    }
    
    .issue-description h3 {
        color: #856404;
        margin: 0 0 10px 0;
        font-size: 18px;
    }
    
    .issue-description p {
        color: #333;
        margin: 0;
        line-height: 1.6;
    }
    
    .image-preview {
        max-width: 100%;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        cursor: pointer;
        transition: transform 0.3s;
    }
    
    .image-preview:hover {
        transform: scale(1.05);
    }
    
    .map-preview {
        height: 400px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .dispatch-form-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .dispatch-form-card h2 {
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #28a745;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
    }
    
    .form-control {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 15px;
        transition: border-color 0.3s;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #28a745;
    }
    
    textarea.form-control {
        min-height: 120px;
        resize: vertical;
    }
    
    .btn-group {
        display: flex;
        gap: 15px;
        margin-top: 30px;
    }
    
    .btn {
        padding: 14px 28px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #218838 0%, #1aa179 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }
    
    .btn-danger:hover {
        background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    }
    
    .status-badge {
        padding: 6px 14px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
        display: inline-block;
    }
    
    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-in-progress {
        background-color: #cfe2ff;
        color: #084298;
    }
    
    .status-resolved {
        background-color: #d1e7dd;
        color: #0f5132;
    }
</style>

<div class="dispatch-container">
    <div class="dispatch-header">
        <h1><i class="fas fa-ambulance"></i> Dispatch Assistance</h1>
        <p>Emergency Request #{{ request.id }} - Coordinate response team</p>
    </div>
    
    <!-- Request Details -->
    <div class="request-details-card">
        <h2><i class="fas fa-info-circle"></i> Request Information</h2>
        
        <div class="detail-grid">
            <div class="detail-item">
                <label><i class="fas fa-hashtag"></i> Request ID</label>
                <div class="value">#{{ request.id }}</div>
            </div>
            
            <div class="detail-item">
                <label><i class="fas fa-user"></i> Driver Name</label>
                <div class="value">{{ request.user_name }}</div>
            </div>
            
            <div class="detail-item">
                <label><i class="fas fa-envelope"></i> Email</label>
                <div class="value">{{ request.user_email }}</div>
            </div>
            
            <div class="detail-item">
                <label><i class="fas fa-phone"></i> Phone</label>
                <div class="value">{{ request.user_phone }}</div>
            </div>
            
            <div class="detail-item">
                <label><i class="fas fa-user-tag"></i> Role</label>
                <div class="value">{{ request.user_role }}</div>
            </div>
            
            <div class="detail-item">
                <label><i class="fas fa-flag"></i> Status</label>
                <div class="value">
                    <span class="status-badge status-{{ request.status_class }}">
                        {{ request.status_display }}
                    </span>
                </div>
            </div>
            
            <div class="detail-item">
                <label><i class="fas fa-clock"></i> Submitted</label>
                <div class="value">{{ request.created_at|date:"Y-m-d H:i:s" }}</div>
            </div>
            
            <div class="detail-item">
                <label><i class="fas fa-map-marker-alt"></i> Location</label>
                <div class="value">
                    {% if request.latitude and request.longitude %}
                        {{ request.latitude|floatformat:6 }}, {{ request.longitude|floatformat:6 }}
                    {% else %}
                        Not available
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Issue Description -->
        <div class="issue-description">
            <h3><i class="fas fa-exclamation-triangle"></i> Issue Description</h3>
            <p>{{ request.issue_description }}</p>
        </div>
        
        <!-- Image if available -->
        {% if request.captured_image %}
        <div class="form-group">
            <label><i class="fas fa-image"></i> Captured Image</label>
            <img src="{{ request.captured_image }}" alt="Request Image" class="image-preview" onclick="window.open('{{ request.captured_image }}', '_blank')">
        </div>
        {% endif %}
        
        <!-- Map Preview -->
        {% if request.latitude and request.longitude %}
        <div class="form-group">
            <label><i class="fas fa-map"></i> Location Map</label>
            <div id="map" class="map-preview"></div>
        </div>
        {% endif %}
    </div>
    
    <!-- Dispatch Form -->
    <div class="dispatch-form-card">
        <h2><i class="fas fa-clipboard-list"></i> Dispatch Response Team</h2>
        
        <form method="POST" id="dispatchForm">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="response_team"><i class="fas fa-users"></i> Response Team *</label>
                <select name="response_team" id="response_team" class="form-control" required>
                    <option value="">Select Response Team</option>
                    <option value="ELECTRICAL_MAINTENANCE">Electrical Maintenance Team</option>
                    <option value="MECHANICAL_MAINTENANCE">Mechanical Maintenance Team</option>
                    <option value="EMERGENCY_RESPONSE">Emergency Response Team</option>
                    <option value="SECURITY">Security Team</option>
                    <option value="MEDICAL">Medical Team</option>
                    <option value="TOWING">Towing Service</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="estimated_arrival"><i class="fas fa-clock"></i> Estimated Arrival Time</label>
                <input type="datetime-local" name="estimated_arrival" id="estimated_arrival" class="form-control">
            </div>
            
            <div class="form-group">
                <label for="response_notes"><i class="fas fa-comment-alt"></i> Response Notes *</label>
                <textarea name="response_notes" id="response_notes" class="form-control" placeholder="Enter notes about the response action..." required></textarea>
            </div>
            
            <div class="form-group">
                <label for="new_status"><i class="fas fa-tasks"></i> Update Status *</label>
                <select name="new_status" id="new_status" class="form-control" required>
                    <option value="IN_PROGRESS" {% if request.status == 'PENDING' %}selected{% endif %}>In Progress</option>
                    <option value="RESOLVED">Resolved</option>
                    <option value="CANCELLED">Cancelled</option>
                </select>
            </div>
            
            <div class="btn-group">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Dispatch Team
                </button>
                <a href="{% url 'emergency_alerts' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Alerts
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Leaflet CSS & JS for Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

<script>
    {% if request.latitude and request.longitude %}
    // Initialize map
    var map = L.map('map').setView([{{ request.latitude }}, {{ request.longitude }}], 15);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    
    // Custom red icon for emergency
    var redIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    // Add emergency marker
    L.marker([{{ request.latitude }}, {{ request.longitude }}], {icon: redIcon})
        .addTo(map)
        .bindPopup(`
            <b>Emergency Location</b><br>
            Driver: {{ request.user_name }}<br>
            Issue: {{ request.issue_description|escapejs }}
        `)
        .openPopup();
    {% endif %}
    
    // Form submission
    document.getElementById('dispatchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (confirm('Are you sure you want to dispatch the response team?')) {
            this.submit();
        }
    });
</script>

{% endblock %}
