{% extends 'base.html' %}
{% block content %}
<div class="container mt-3">
  
  <!-- Placeholder: frontend should call /api/schedules/ and render calendar -->
  <div id="schedule-root">
    {% load static %}
    <div class="container mt-3">

      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Scheduling Dashboard</h2>
        <div>
          <button id="refreshBtn" class="btn btn-secondary">Refresh</button>
          <button id="newScheduleBtn" class="btn btn-primary">New Schedule</button>
        </div>
      </div>

      <!-- Color legend and driver status summary -->
      <div class="mb-3">
        <div class="mb-2">
          <span class="badge" style="background:#28a745">Available</span>
          <span class="badge" style="background:#dc3545">On Leave</span>
          <span class="badge" style="background:#fd7e14">Emergency</span>
        </div>
        <div class="card">
          <div class="card-header">Driver Status Overview</div>
          <div class="card-body p-2">
            <div style="max-height: 300px; overflow-y: auto;">
              <table class="table table-sm mb-0" id="driverStatusTable">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div id='calendar'></div>

      <!-- Modal for create/edit -->
      <div class="modal fade" id="scheduleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form id="scheduleForm">
              {% csrf_token %}
              <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">New Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" id="scheduleId" />
                <div class="mb-2">
                  <label class="form-label">Driver</label>
                  <select id="driverSelect" class="form-select" required></select>
                </div>
                <div class="mb-2">
                  <label class="form-label">Assistant (optional)</label>
                  <select id="assistantSelect" class="form-select"></select>
                </div>
                <div class="mb-2">
                  <label class="form-label">Date</label>
                  <input type="date" id="dateInput" class="form-control" required />
                </div>
                <div class="mb-2">
                  <label class="form-label">Shift</label>
                  <select id="shiftSelect" class="form-select">
                    <option value="day">Day</option>
                    <option value="week">Week</option>
                    <option value="month">Month</option>
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label">Status</label>
                  <select id="statusSelect" class="form-select">
                    <option value="available">Available</option>
                    <option value="on_leave">On Leave</option>
                    <option value="emergency">Emergency</option>
                    <option value="assigned">Assigned</option>
                    <option value="completed">Completed</option>
                  </select>
                </div>
                <div id="modalAlert" class="alert alert-danger d-none"></div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-danger me-auto" id="deleteBtn">Delete</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
              </div>
            </form>
          </div>
        </div>
      </div>

    </div>

    <!-- FullCalendar & dependencies -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

    <script>
    // CSRF helper
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Color mapping
    const statusColor = {
      'on_leave': '#dc3545', // red
      'emergency': '#fd7e14', // orange
      'available': '#28a745', // green
      'assigned': '#0d6efd', // blue
      'completed': '#6c757d' // gray
    };

    let calendar;
    let drivers = [];
    let assistants = [];
    let locomotives = [];

    async function fetchLists() {
      // Drivers
      const dResp = await fetch('/api/drivers/?page_size=1000');
      const dJson = await dResp.json();
      drivers = dJson.results || dJson;
      // build driver select
      const driverSelect = document.getElementById('driverSelect');
      const assistantSelect = document.getElementById('assistantSelect');
      driverSelect.innerHTML = '';
      assistantSelect.innerHTML = '<option value="-- none --</option>';
      drivers.forEach(d => {
        const name = (d.first_name ? d.first_name : '') + (d.last_name ? ' ' + d.last_name : '');
        const opt = document.createElement('option');
        opt.value = d.User_id;
        opt.text = name.trim() ? name : 'Unknown';
        driverSelect.appendChild(opt);
      });
      // Only show assistants in same area as selected driver
      driverSelect.addEventListener('change', function() {
        const selectedDriver = drivers.find(x => x.User_id === driverSelect.value);
        assistantSelect.innerHTML = '<option value="-- none --</option>';
        if (!selectedDriver) return;
        drivers.forEach(d => {
          if (d.User_id !== selectedDriver.User_id && d.current_location === selectedDriver.current_location) {
            const name = (d.first_name ? d.first_name : '') + (d.last_name ? ' ' + d.last_name : '');
            const opt = document.createElement('option');
            opt.value = d.User_id;
            opt.text = name.trim() ? name : 'Unknown';
            assistantSelect.appendChild(opt);
          }
        });
      });
      // Trigger once on load
      driverSelect.dispatchEvent(new Event('change'));
    }

    async function fetchEvents(info, successCallback, failureCallback) {
      try {
        const resp = await fetch('/api/schedules/?page_size=1000');
        const data = await resp.json();
        const items = data.results || data;
        const events = items.map(s => {
          let name = '';
          if (s.driver_detail) {
            name = (s.driver_detail.first_name ? s.driver_detail.first_name : '') + (s.driver_detail.last_name ? ' ' + s.driver_detail.last_name : '');
          }
          return {
            id: s.id,
            title: name.trim() ? name : 'Unknown',
            start: s.date,
            extendedProps: s,
            backgroundColor: statusColor[s.status] || '#0d6efd',
            borderColor: statusColor[s.status] || '#0d6efd',
          };
        });
        successCallback(events);
      } catch (err) {
        failureCallback(err);
      }
    }

    function openModalForCreate(dateStr) {
      document.getElementById('modalTitle').innerText = 'New Schedule';
      document.getElementById('scheduleId').value = '';
      document.getElementById('dateInput').value = dateStr || '';
      document.getElementById('shiftSelect').value = 'day';
      document.getElementById('statusSelect').value = 'available';
      document.getElementById('modalAlert').classList.add('d-none');
      document.getElementById('deleteBtn').style.display = 'none';
      var modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
      modal.show();
    }

    function openModalForEdit(event) {
      const s = event.extendedProps;
      document.getElementById('modalTitle').innerText = 'Edit Schedule';
      document.getElementById('scheduleId').value = s.id;
      document.getElementById('dateInput').value = s.date;
      document.getElementById('shiftSelect').value = s.shift_type || 'day';
      document.getElementById('statusSelect').value = s.status || 'available';
      document.getElementById('driverSelect').value = s.driver;
      document.getElementById('assistantSelect').value = s.assistant || '';
      document.getElementById('modalAlert').classList.add('d-none');
      document.getElementById('deleteBtn').style.display = 'inline-block';
      var modal = new bootstrap.Modal(document.getElementById('scheduleModal'));
      modal.show();
    }

    async function saveSchedule(e) {
      e.preventDefault();
      const id = document.getElementById('scheduleId').value;
      const payload = {
        driver: document.getElementById('driverSelect').value,
        assistant: document.getElementById('assistantSelect').value || null,
        date: document.getElementById('dateInput').value,
        shift_type: document.getElementById('shiftSelect').value,
        status: document.getElementById('statusSelect').value
      };

      // frontend validation: driver availability
      const drv = drivers.find(d => d.User_id === payload.driver);
      if (drv && (drv.driver_status === 'on_leave' || drv.driver_status === 'emergency')) {
        const alert = document.getElementById('modalAlert');
        let reason = drv.driver_status === 'on_leave' ? 'on leave' : 'has reported an emergency';
        alert.innerText = `This driver cannot be scheduled because they are currently ${reason}. Please select another available driver.`;
        alert.classList.remove('d-none');
        return;
      }

      try {
        let url = '/api/schedules/';
        let method = 'POST';
        if (id) { url += id + '/'; method = 'PUT'; }
        const resp = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify(payload)
        });
        if (!resp.ok) {
          let errText = await resp.text();
          let errMsg = '';
          try {
            const errJson = JSON.parse(errText);
            if (typeof errJson === 'string') {
              errMsg = errJson;
            } else if (errJson && typeof errJson === 'object') {
              if (errJson.non_field_errors) {
                errMsg = errJson.non_field_errors.join(' ');
              } else if (errJson.error) {
                errMsg = errJson.error;
              } else {
                errMsg = JSON.stringify(errJson);
              }
            } else {
              errMsg = errText;
            }
          } catch {
            errMsg = errText || 'Unknown error';
          }
          const alert = document.getElementById('modalAlert');
          alert.innerText = errMsg;
          alert.classList.remove('d-none');
          return;
        }
        // close modal and refresh
        bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
        calendar.refetchEvents();
      } catch (err) {
        const alert = document.getElementById('modalAlert');
        alert.innerText = (err && err.message) ? err.message : (typeof err === 'string' ? err : JSON.stringify(err));
        alert.classList.remove('d-none');
      }
    }

    async function deleteSchedule() {
      const id = document.getElementById('scheduleId').value;
      if (!id) return;
      if (!confirm('Delete this schedule?')) return;
      try {
        const resp = await fetch('/api/schedules/' + id + '/', {
          method: 'DELETE',
          headers: { 'X-CSRFToken': csrftoken }
        });
        if (!resp.ok) throw await resp.text();
        bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
        calendar.refetchEvents();
      } catch (err) {
        alert('Delete failed: ' + err);
      }
    }

    document.addEventListener('DOMContentLoaded', async function() {
      await fetchLists();

      // Populate driver status table
      const tableBody = document.querySelector('#driverStatusTable tbody');
      tableBody.innerHTML = '';
      drivers.forEach(d => {
        let color = d.driver_status === 'on_leave' ? '#dc3545' : (d.driver_status === 'emergency' ? '#fd7e14' : '#28a745');
        let statusLabel = d.driver_status === 'on_leave' ? 'On Leave' : (d.driver_status === 'emergency' ? 'Emergency' : 'Available');
        let name = (d.first_name ? d.first_name : '') + (d.last_name ? ' ' + d.last_name : '');
        let row = `<tr>
          <td>${name.trim() ? name : 'Unknown'}</td>
          <td>${d.email}</td>
          <td><span class="badge" style="background:${color}">${statusLabel}</span></td>
        </tr>`;
        tableBody.insertAdjacentHTML('beforeend', row);
      });

      var calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: fetchEvents,
        dateClick: function(info) {
          openModalForCreate(info.dateStr);
        },
        eventClick: function(info) {
          openModalForEdit(info.event);
        }
      });
      calendar.render();

      document.getElementById('newScheduleBtn').addEventListener('click', function(){ openModalForCreate(); });
      document.getElementById('refreshBtn').addEventListener('click', function(){ calendar.refetchEvents(); });
      document.getElementById('scheduleForm').addEventListener('submit', saveSchedule);
      document.getElementById('deleteBtn').addEventListener('click', deleteSchedule);
    });
    </script>

    {% endblock %}
