{% extends 'base.html' %}

{% block title %}Cargo Specifications{% endblock %}
{% block content %}
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .builder, .survey { margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; }
    .question { margin: 10px 0; }
    label { display: block; margin-bottom: 5px; }
    input, select, button, textarea { margin: 5px 0; }
  </style>
            <!-- Main Content -->
            <div class="p-4">
                
                
            <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="">CARGO ATTRIBUTES</h3>
                    </div>

                
                <div class="card-body">
                    <form id="cargoForm" method="post" action="">
                      {% csrf_token %}
                      <input type="hidden" name="selected_spec_id" value="" />
                      <div class="mb-3">
                        <label class="form-label">Select Cargo</label>
                        <div class="input-group">
                          <select class="form-select" name="cargo_select">
                            <option value="" disabled selected>Select cargo...</option>
                            {% if cargos %}
                              {% for c in cargos %}
                                <option value="{{ c.id }}">{{ c.name }}</option>
                              {% endfor %}
                              <option disabled></option>
                            {% endif %}
                          </select>
                          <button id="selectCargoBtn" class="btn btn-primary" type="button">Select</button>
                        </div>
                      </div>
                      <div id="dynamicSurveyFields"></div>
                      <div id="surveyPreviewInForm" class="mb-3"></div>
     
                    <div class="row">
                        <div class="col-md">
                            <div class="card mb-4">
                                <div class="card-body">
                  <div class="spec-item">
                    <label class="form-label ">Cargo Type</label>
                    <input type="text" name="cargo_type" class="form-control" placeholder="Cargo Type">
                  </div>
                  <div class="spec-item">
                    <label class="form-label">Cargo Volume M³</label>
                    <input type="number" name="cargo_volume" class="form-control" placeholder="Cargo Volume M³">
                  </div>
                  <div class="spec-item">
                    <label class="form-label ">Special handling Requirements if any</label>
                    <input type="text" name="special_handling" class="form-control" placeholder="Special handling Requirements if any">
                  </div>
                                </div>
                            </div>
                        </div>
    
                        
                    </div>
    
          <div class="d-flex justify-content-end mt-4 gap-2">
            <button type="reset" class="btn btn-outline-secondary">Cancel</button>
            <button type="submit" class="btn btn-primary">Submit</button>
          </div>
          </form>
          <!-- Question Builder inside same card -->
          <div class="builder mt-4">
            <h2>Add Section</h2>
            <div class="mb-3">
              <label class="form-label">Question Text:</label>
              <input class="form-control" type="text" id="questionText">
            </div>
            <div class="mb-3">
              <label class="form-label">Question Type:</label>
              <select class="form-select" id="questionType">
                <option value="text">Short Text</option>
                <option value="textarea">Long Text</option>
                <option value="radio">Multiple Choice (Single)</option>
                <option value="checkbox">Multiple Choice (Multiple)</option>
                <option value="dropdown">Dropdown</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Options (comma separated, for radio/checkbox/dropdown):</label>
              <input class="form-control" type="text" id="options">
            </div>
            <button class="btn btn-outline-dark" onclick="addQuestion()">Add Question</button>
          </div>
        </div>
    </div>
                
            </div>
        </div>
    </div>

  <!-- survey preview moved into the cargo form above -->

  <script>
  let questionIndex = 0;
  const surveyPreview = document.getElementById("surveyPreviewInForm");
  const dynamicFields = document.getElementById("dynamicSurveyFields");

    function addQuestion() {
      const text = document.getElementById("questionText").value.trim();
      const type = document.getElementById("questionType").value;
      const options = document.getElementById("options").value.split(",").map(o => o.trim()).filter(o => o);

      if (!text) {
        alert("Please enter a question text");
        return;
      }

      const idx = questionIndex++;

      // Add compact preview in the form
      const previewWrapper = document.createElement("div");
      previewWrapper.classList.add("question");
      previewWrapper.id = `preview-${idx}`;
      const previewLabel = document.createElement("strong");
      previewLabel.textContent = text;
      previewWrapper.appendChild(previewLabel);
      const typeBadge = document.createElement('span');
      typeBadge.className = 'badge bg-secondary ms-2';
      const typeMap = {
        text: 'Short Text',
        textarea: 'Long Text',
        radio: 'Multiple Choice (Single)',
        checkbox: 'Multiple Choice (Multiple)',
        dropdown: 'Dropdown'
      };
      typeBadge.textContent = typeMap[type] || type;
      previewWrapper.appendChild(typeBadge);
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn btn-sm btn-outline-danger ms-2';
      removeBtn.textContent = 'Remove';
      removeBtn.addEventListener('click', () => {
        const metaEl = document.getElementById(`meta-${idx}`);
        const answerEl = document.getElementById(`answer-${idx}`);
        const previewEl = document.getElementById(`preview-${idx}`);
        if (metaEl) metaEl.remove();
        if (answerEl) answerEl.remove();
        if (previewEl) previewEl.remove();
      });
      previewWrapper.appendChild(removeBtn);
      surveyPreview.appendChild(previewWrapper);

      // Add metadata hidden input to cargo form: survey_questions[] (JSON)
      const meta = document.createElement('input');
      meta.type = 'hidden';
      meta.name = 'survey_questions[]';
      meta.id = `meta-${idx}`;
      meta.value = JSON.stringify({ text: text, type: type, options: options });
      dynamicFields.appendChild(meta);

      // Add visible answer input to cargo form with indexed names
      const answerWrapper = document.createElement('div');
      answerWrapper.classList.add('form-group-row');
      answerWrapper.id = `answer-${idx}`;
      const answerLabel = document.createElement('label');
      answerLabel.textContent = text;
      answerWrapper.appendChild(answerLabel);

      if (type === 'text') {
        const a = document.createElement('input');
        a.type = 'text';
        a.name = `survey_answers[${idx}]`;
        a.className = 'form-control';
        answerWrapper.appendChild(a);
      } else if (type === 'textarea') {
        const a = document.createElement('textarea');
        a.name = `survey_answers[${idx}]`;
        a.className = 'form-control';
        answerWrapper.appendChild(a);
      } else if (type === 'radio') {
        const optsDiv = document.createElement('div');
        options.forEach(opt => {
          const r = document.createElement('input');
          r.type = 'radio';
          r.name = `survey_answers[${idx}]`;
          r.value = opt;
          r.className = 'me-1';
          const lbl = document.createElement('label');
          lbl.className = 'me-3';
          lbl.appendChild(r);
          lbl.appendChild(document.createTextNode(opt));
          optsDiv.appendChild(lbl);
        });
        answerWrapper.appendChild(optsDiv);
      } else if (type === 'dropdown') {
        const sel = document.createElement('select');
        sel.name = `survey_answers[${idx}]`;
        sel.className = 'form-select';
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = 'Select an option';
        sel.appendChild(defaultOpt);
        options.forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          sel.appendChild(o);
        });
        answerWrapper.appendChild(sel);
      } else if (type === 'checkbox') {
        const boxContainer = document.createElement('div');
        options.forEach(opt => {
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.name = `survey_answers[${idx}][]`;
          cb.value = opt;
          cb.className = 'me-1';
          const lbl = document.createElement('label');
          lbl.className = 'me-3';
          lbl.appendChild(cb);
          lbl.appendChild(document.createTextNode(opt));
          boxContainer.appendChild(lbl);
        });
        answerWrapper.appendChild(boxContainer);
      }

      dynamicFields.appendChild(answerWrapper);

      // Reset builder form
      document.getElementById("questionText").value = "";
      document.getElementById("options").value = "";
    }
  </script>
    <script>
      (function(){
        const sel = document.querySelector('select[name="cargo_select"]');
        const btn = document.getElementById('selectCargoBtn');
        if (!sel) return;
        const endpoint = "{% url 'api_get_cargo_spec' %}";
        function fetchSpecById(id){
          if (!id) return;
          fetch(endpoint + '?id=' + encodeURIComponent(id))
            .then(r => { if (r.status === 204) return null; return r.json(); })
            .then(data => {
              if (!data) return;
              const set = (n,v) => { const el = document.querySelector('[name="'+n+'"]'); if (el) el.value = v || ''; };
              const selIdEl = document.querySelector('[name="selected_spec_id"]'); if (selIdEl) selIdEl.value = data.id || '';
              set('cargo_type', data.cargo_type);
              set('cargo_volume', data.cargo_volume);
              set('special_handling', data.special_handling);
            }).catch(err => console.warn('cargo fetch', err));
        }
        sel.addEventListener('change', () => fetchSpecById(sel.value));
        if (btn) btn.addEventListener('click', () => fetchSpecById(sel.value));
      })();
    </script>
    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    {% endblock %}