{% extends 'base.html' %}

{% block title %}Wheelset Specifications{% endblock %}
{% block content %}
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .builder, .survey { margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; }
    .question { margin: 10px 0; }
    label { display: block; margin-bottom: 5px; }
    input, select, button, textarea { margin: 5px 0; }
  </style>
            <!-- Main Content -->
            <div class="container-fluid px-3">
            
                
                <div class="row">
                    <div class="col-md-12">
                        <div class="card mt-4">
                            <div class="card-header" style="background: linear-gradient(135deg, #E31937 0%, #8B0000 100%);">
                            <h3 class="text-white mb-0">‚öôÔ∏è WHEELSET SPECIFICATIONS</h3></div>
              <div class="card-body">
                <form id="wheelsetForm" method="post" action="">
                  {% csrf_token %}
                  <input type="hidden" name="selected_spec_id" value="" />
                  
                  <div class="mb-3">
                    <label class="form-label">Select Locomotive *</label>
                    <select class="form-select" name="locomotive_id" required>
                      <option value="" disabled selected>Select locomotive...</option>
                      {% if locomotives %}
                        {% for loco in locomotives %}
                          <option value="{{ loco.id }}">{{ loco.name }}</option>
                        {% endfor %}
                      {% else %}
                        <option disabled>No locomotives available</option>
                      {% endif %}
                    </select>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Select Wheelset</label>
                    <div class="input-group">
                      <select class="form-select" name="wheel_select">
                        <option value="" disabled selected>Select wheelset...</option>
                        {% if wheels %}
                          {% for w in wheels %}
                            <option value="{{ w.id }}">{{ w.locomotive_name }} - {{ w.wheel_profile }}</option>
                          {% endfor %}
                          <option disabled></option>
                        {% endif %}
                      </select>
                      <button id="selectWheelBtn" class="btn btn-primary" type="button">Select</button>
                    </div>
                  </div>
                  <div id="dynamicSurveyFields"></div>
                  <div id="surveyPreviewInForm" class="mb-3"></div>
                                
                <div class="spec-item">
                  <label class="form-label">Wheel Profile</label>
                  <input type="text" name="wheel_profile" class="form-control" placeholder="Enter wheel profile type (e.g., S1002, AAR-1B, UIC)">
                </div>
                                
                <div class="spec-item">
                  <label class="form-label">Diameter Differentials</label>
                  <input type="text" name="diameter_differentials" class="form-control" placeholder="Enter diameter differentials in mm (e.g., 920mm, 1000mm)">
                </div>
                                
                <div class="spec-item">
                  <label class="form-label">Symmetry</label>
                  <input type="text" name="symmetry" class="form-control" placeholder="Enter symmetry measurements (e.g., Within 0.5mm tolerance)">
                </div>
                                
                                
                <div class="spec-item">
                  <label class="form-label">Radial Run Out</label>
                  <input type="text" name="radial_run_out" class="form-control" placeholder="Enter radial run out in mm (e.g., 0.3mm, 0.5mm)">
                </div>
                                
                <div class="spec-item">
                  <label class="form-label">Axial Run Out</label>
                  <input type="text" name="axial_run_out" class="form-control" placeholder="Enter axial run out in mm (e.g., 0.2mm, 0.4mm)">
                </div>
                                
                <div class="spec-item">
                  <label class="form-label">Witness Marks</label>
                  <input type="text" name="witness_marks" class="form-control" placeholder="Enter witness marks observations (e.g., None, Minor surface marks)">
                </div>
                                
                <div class="spec-item">
                  <label class="form-label">Surface Roughness</label>
                  <input type="text" name="surface_roughness" class="form-control" placeholder="Enter surface roughness Ra value (e.g., 1.6Œºm, 3.2Œºm)">
                </div>
                                
                <div class="spec-item">
                  <label class="form-label">Stenciling</label>
                  <input type="text" name="stenciling" class="form-control" placeholder="Enter stenciling details (e.g., WS-001, Date: 2025-01)">
                </div>
                                
                <div class="spec-item">
                  <label class="form-label">Main Machine Diameter</label>
                  <input type="text" name="main_machine_diameter" class="form-control" placeholder="Enter main machine diameter in mm (e.g., 920mm, 1000mm)">
                </div>

                <div class="d-flex justify-content-end mt-4 gap-2">
                  <button type="reset" class="btn btn-outline-secondary">Cancel</button>
                  <button type="submit" class="btn btn-primary">Submit</button>
                </div>
                </form>
              </div>
            </div>
          </div>


        </div>
      </div>
        </div>
    </div>
        <!-- Question Builder inside same card -->
  <div class="builder mt-4">
    <h2 class="card-title">üìã Add Additional Specifications</h2>
    <p class="text-muted">Use this section to add any additional wheelset specifications not covered in the form above.</p>
    <div class="mb-3">
      <label class="form-label">Question Text:</label>
      <input class="form-control" type="text" id="questionText">
    </div>
    <div class="mb-3">
      <label class="form-label">Question Type:</label>
      <select class="form-select" id="questionType">
        <option value="text">Short Text</option>
        <option value="textarea">Long Text</option>
        <option value="radio">Multiple Choice (Single)</option>
        <option value="checkbox">Multiple Choice (Multiple)</option>
        <option value="dropdown">Dropdown</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label">Options (comma separated, for radio/checkbox/dropdown):</label>
      <input class="form-control" type="text" id="options">
    </div>
    <button class="btn btn-outline-dark" onclick="addQuestion()">Add Question</button>
  </div>

  <!-- survey preview moved into the wheelset form above -->
  <script>
  let questionIndex = 0;
  const surveyPreview = document.getElementById("surveyPreviewInForm");
  const dynamicFields = document.getElementById("dynamicSurveyFields");

    // Function to parse survey_raw and recreate questions for editing
    function loadSurveyQuestions(surveyRaw) {
      if (!surveyRaw || surveyRaw.trim() === '') return;
      
      // Clear existing questions
      surveyPreview.innerHTML = '';
      dynamicFields.innerHTML = '';
      questionIndex = 0;
      
      const parts = surveyRaw.split(',');
      
      // Group every 3 parts: [text, type, answers]
      for (let i = 0; i < parts.length; i += 3) {
        if (i + 1 >= parts.length) break;
        
        const qtext = parts[i] || '';
        const qtype = parts[i + 1] || 'text';
        const answersStr = parts[i + 2] || '';
        
        if (!qtext.trim()) continue;
        
        let options = [];
        if (answersStr && (qtype === 'radio' || qtype === 'checkbox' || qtype === 'dropdown')) {
          options = answersStr.split(',').map(o => o.trim()).filter(o => o);
          if (options.length === 0) options = ['Option 1', 'Option 2'];
        }
        
        recreateQuestion(qtext, qtype, options, answersStr);
      }
    }
    
    // Helper function to recreate a question
    function recreateQuestion(text, type, options, answer) {
      const idx = questionIndex++;

      const previewWrapper = document.createElement("div");
      previewWrapper.className = 'd-flex align-items-center justify-content-between mb-2 p-2 border rounded';
      previewWrapper.id = `preview-${idx}`;
      
      const leftSection = document.createElement('div');
      leftSection.className = 'd-flex align-items-center';
      
      const previewLabel = document.createElement("strong");
      previewLabel.textContent = text;
      leftSection.appendChild(previewLabel);
      
      const typeBadge = document.createElement('span');
      typeBadge.className = 'badge bg-secondary ms-2';
      const typeMap = {
        text: 'Short Text',
        textarea: 'Long Text',
        radio: 'Multiple Choice (Single)',
        checkbox: 'Multiple Choice (Multiple)',
        dropdown: 'Dropdown'
      };
      typeBadge.textContent = typeMap[type] || type;
      leftSection.appendChild(typeBadge);
      
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn btn-sm btn-danger';
      removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
      removeBtn.addEventListener('click', () => {
        document.getElementById(`meta-${idx}`)?.remove();
        document.getElementById(`answer-${idx}`)?.remove();
        document.getElementById(`preview-${idx}`)?.remove();
      });
      
      previewWrapper.appendChild(leftSection);
      previewWrapper.appendChild(removeBtn);
      surveyPreview.appendChild(previewWrapper);

      const meta = document.createElement('input');
      meta.type = 'hidden';
      meta.name = 'survey_questions[]';
      meta.id = `meta-${idx}`;
      meta.value = JSON.stringify({ text: text, type: type, options: options });
      dynamicFields.appendChild(meta);

      const answerWrapper = document.createElement('div');
      answerWrapper.classList.add('form-group-row');
      answerWrapper.id = `answer-${idx}`;
      const answerLabel = document.createElement('label');
      answerLabel.textContent = text;
      answerWrapper.appendChild(answerLabel);

      if (type === 'text') {
        const a = document.createElement('input');
        a.type = 'text';
        a.name = `survey_answers[${idx}]`;
        a.className = 'form-control';
        a.value = answer || '';
        answerWrapper.appendChild(a);
      } else if (type === 'textarea') {
        const a = document.createElement('textarea');
        a.name = `survey_answers[${idx}]`;
        a.className = 'form-control';
        a.value = answer || '';
        answerWrapper.appendChild(a);
      } else if (type === 'radio') {
        const optsDiv = document.createElement('div');
        const answerValues = answer ? answer.split(',').map(v => v.trim()) : [];
        options.forEach(opt => {
          const r = document.createElement('input');
          r.type = 'radio';
          r.name = `survey_answers[${idx}]`;
          r.value = opt;
          r.className = 'me-1';
          if (answerValues.includes(opt)) r.checked = true;
          const lbl = document.createElement('label');
          lbl.className = 'me-3';
          lbl.appendChild(r);
          lbl.appendChild(document.createTextNode(opt));
          optsDiv.appendChild(lbl);
        });
        answerWrapper.appendChild(optsDiv);
      } else if (type === 'dropdown') {
        const sel = document.createElement('select');
        sel.name = `survey_answers[${idx}]`;
        sel.className = 'form-select';
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = '-- Select --';
        sel.appendChild(defaultOpt);
        options.forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          if (answer === opt) o.selected = true;
          sel.appendChild(o);
        });
        answerWrapper.appendChild(sel);
      } else if (type === 'checkbox') {
        const boxContainer = document.createElement('div');
        const answerValues = answer ? answer.split(',').map(v => v.trim()) : [];
        options.forEach(opt => {
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.name = `survey_answers[${idx}][]`;
          cb.value = opt;
          cb.className = 'me-1';
          if (answerValues.includes(opt)) cb.checked = true;
          const lbl = document.createElement('label');
          lbl.className = 'me-3';
          lbl.appendChild(cb);
          lbl.appendChild(document.createTextNode(opt));
          boxContainer.appendChild(lbl);
        });
        answerWrapper.appendChild(boxContainer);
      }

      dynamicFields.appendChild(answerWrapper);
    }

    function addQuestion() {
      const text = document.getElementById("questionText").value.trim();
      const type = document.getElementById("questionType").value;
      const options = document.getElementById("options").value.split(",").map(o => o.trim()).filter(o => o);

      if (!text) {
        alert("Please enter a question text");
        return;
      }

      const idx = questionIndex++;

      // Add compact preview in the form
      const previewWrapper = document.createElement("div");
      previewWrapper.classList.add("question");
      previewWrapper.id = `preview-${idx}`;
      const previewLabel = document.createElement("strong");
      previewLabel.textContent = text;
      previewWrapper.appendChild(previewLabel);
      const typeBadge = document.createElement('span');
      typeBadge.className = 'badge bg-secondary ms-2';
      const typeMap = {
        text: 'Short Text',
        textarea: 'Long Text',
        radio: 'Multiple Choice (Single)',
        checkbox: 'Multiple Choice (Multiple)',
        dropdown: 'Dropdown'
      };
      typeBadge.textContent = typeMap[type] || type;
      previewWrapper.appendChild(typeBadge);
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn btn-sm btn-outline-danger ms-2';
      removeBtn.textContent = 'Remove';
      removeBtn.addEventListener('click', () => {
        const metaEl = document.getElementById(`meta-${idx}`);
        const answerEl = document.getElementById(`answer-${idx}`);
        const previewEl = document.getElementById(`preview-${idx}`);
        if (metaEl) metaEl.remove();
        if (answerEl) answerEl.remove();
        if (previewEl) previewEl.remove();
      });
      previewWrapper.appendChild(removeBtn);
      surveyPreview.appendChild(previewWrapper);

      // Add metadata hidden input to wheelset form: survey_questions[] (JSON)
      const meta = document.createElement('input');
      meta.type = 'hidden';
      meta.name = 'survey_questions[]';
      meta.id = `meta-${idx}`;
      meta.value = JSON.stringify({ text: text, type: type, options: options });
      dynamicFields.appendChild(meta);

      // Add visible answer input to wheelset form with indexed names
      const answerWrapper = document.createElement('div');
      answerWrapper.classList.add('form-group-row');
      answerWrapper.id = `answer-${idx}`;
      const answerLabel = document.createElement('label');
      answerLabel.textContent = text;
      answerWrapper.appendChild(answerLabel);

      if (type === 'text') {
        const a = document.createElement('input');
        a.type = 'text';
        a.name = `survey_answers[${idx}]`;
        a.className = 'form-control';
        answerWrapper.appendChild(a);
      } else if (type === 'textarea') {
        const a = document.createElement('textarea');
        a.name = `survey_answers[${idx}]`;
        a.className = 'form-control';
        answerWrapper.appendChild(a);
      } else if (type === 'radio') {
        const optsDiv = document.createElement('div');
        options.forEach(opt => {
          const r = document.createElement('input');
          r.type = 'radio';
          r.name = `survey_answers[${idx}]`;
          r.value = opt;
          r.className = 'me-1';
          const lbl = document.createElement('label');
          lbl.className = 'me-3';
          lbl.appendChild(r);
          lbl.appendChild(document.createTextNode(opt));
          optsDiv.appendChild(lbl);
        });
        answerWrapper.appendChild(optsDiv);
      } else if (type === 'dropdown') {
        const sel = document.createElement('select');
        sel.name = `survey_answers[${idx}]`;
        sel.className = 'form-select';
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = 'Select an option';
        sel.appendChild(defaultOpt);
        options.forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          sel.appendChild(o);
        });
        answerWrapper.appendChild(sel);
      } else if (type === 'checkbox') {
        const boxContainer = document.createElement('div');
        options.forEach(opt => {
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.name = `survey_answers[${idx}][]`;
          cb.value = opt;
          cb.className = 'me-1';
          const lbl = document.createElement('label');
          lbl.className = 'me-3';
          lbl.appendChild(cb);
          lbl.appendChild(document.createTextNode(opt));
          boxContainer.appendChild(lbl);
        });
        answerWrapper.appendChild(boxContainer);
      }

      dynamicFields.appendChild(answerWrapper);

      // Reset builder form
      document.getElementById("questionText").value = "";
      document.getElementById("options").value = "";
    }
  </script>
    <script>
      // Additional Specs Functions - Define early so they're available everywhere
      let additionalSpecCount = 0;
      
      function addAdditionalSpecField(label = '', value = '') {
        const container = document.getElementById('additionalSpecsContainer');
        const fieldGroup = document.createElement('div');
        fieldGroup.className = 'row mb-3 additional-spec-field';
        fieldGroup.id = `additional-spec-${additionalSpecCount}`;
        
        fieldGroup.innerHTML = `
          <div class="col-md-5">
            <input type="text" class="form-control" name="additional_label[]" placeholder="Field Label (e.g., 'Bearing Type')" value="${label}">
          </div>
          <div class="col-md-5">
            <input type="text" class="form-control" name="additional_value[]" placeholder="Field Value (e.g., 'Roller Bearing')" value="${value}">
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeAdditionalSpecField(${additionalSpecCount})">
              <i class="fas fa-trash"></i> Remove
            </button>
          </div>
        `;
        
        container.appendChild(fieldGroup);
        additionalSpecCount++;
      }
      
      function removeAdditionalSpecField(id) {
        const field = document.getElementById(`additional-spec-${id}`);
        if (field) {
          field.remove();
        }
      }
      
      function loadAdditionalSpecs(specs) {
        if (specs && Array.isArray(specs)) {
          specs.forEach(spec => {
            addAdditionalSpecField(spec.label || '', spec.value || '');
          });
        }
      }
      
      (function(){
        const sel = document.querySelector('select[name="wheel_select"]');
        const btn = document.getElementById('selectWheelBtn');
        if (!sel) return;
        const endpoint = "{% url 'api_get_wheelset_spec' %}";
        function fetchSpecById(id){
          if (!id) return;
          
          // Clear existing survey questions first
          if (typeof surveyPreview !== 'undefined' && surveyPreview) surveyPreview.innerHTML = '';
          if (typeof dynamicFields !== 'undefined' && dynamicFields) dynamicFields.innerHTML = '';
          if (typeof questionIndex !== 'undefined') questionIndex = 0;
          
          fetch(endpoint + '?id=' + encodeURIComponent(id))
            .then(r => { if (r.status === 204) return null; return r.json(); })
            .then(data => {
              if (!data) return;
              const set = (n,v) => { const el = document.querySelector('[name="'+n+'"]'); if (el) el.value = v || ''; };
              const selIdEl = document.querySelector('[name="selected_spec_id"]'); if (selIdEl) selIdEl.value = data.id || '';
              set('locomotive_id', data.locomotive_id);
              set('wheel_profile', data.wheel_profile);
              set('diameter_differentials', data.diameter_differentials);
              set('symmetry', data.symmetry);
              set('radial_run_out', data.radial_run_out);
              set('axial_run_out', data.axial_run_out);
              set('witness_marks', data.witness_marks);
              set('surface_roughness', data.surface_roughness);
              set('stenciling', data.stenciling);
              set('main_machine_diameter', data.main_machine_diameter);
              
              // Load survey questions from survey_raw
              if (data.survey_raw) {
                loadSurveyQuestions(data.survey_raw);
              }
            }).catch(err => console.warn('wheelset fetch', err));
        }
        sel.addEventListener('change', () => fetchSpecById(sel.value));
        if (btn) btn.addEventListener('click', () => fetchSpecById(sel.value));
      })();
    </script>

</div>
<!-- End of main content -->

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    {% endblock %}