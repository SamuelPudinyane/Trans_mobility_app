{% extends 'base.html' %}

{% block title %}Wagon Specifications{% endblock %}
{% block content %}
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .builder, .survey { margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; }
    .question { margin: 10px 0; }
    label { display: block; margin-bottom: 5px; }
    input, select, button, textarea { margin: 5px 0; }
    .spec-section { margin-bottom: 30px; }
    .spec-section h4 { color: #E31937; margin-bottom: 15px; border-bottom: 2px solid #E31937; padding-bottom: 5px; }
  </style>
            <!-- Main Content -->
            <div class="container-fluid px-3">
                
                
            <div class="card mt-4">
                    <div class="card-header" style="background: linear-gradient(135deg, #E31937 0%, #8B0000 100%);">
                        <h3 class="text-white mb-0">üöÉ FREIGHT WAGON SPECIFICATIONS</h3>
                    </div>

                
                <div class="card-body">
                    <form id="wagonForm" method="post" action="">
                      {% csrf_token %}
                      <input type="hidden" name="selected_spec_id" value="" />
                      
                      <div class="mb-3">
                        <label class="form-label">Select Existing Wagon</label>
                        <div class="input-group">
                          <select class="form-select" name="wagon_select">
                            <option value="" disabled selected>Select wagon...</option>
                            {% if wagons %}
                              {% for w in wagons %}
                                <option value="{{ w.id }}">{{ w.wagon_number }} - {{ w.wagon_type }} ({{ w.payload_capacity }}t)</option>
                              {% endfor %}
                              <option disabled></option>
                            {% endif %}
                          </select>
                          <button id="selectWagonBtn" class="btn btn-primary" type="button">Load</button>
                        </div>
                      </div>

                      <div id="dynamicSurveyFields"></div>
                      <div id="surveyPreviewInForm" class="mb-3"></div>
     
                    <!-- General Identification -->
                    <div class="spec-section">
                        <h4>üîñ General Identification</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Wagon Number *</label>
                                    <input type="text" name="wagon_number" class="form-control" placeholder="Enter unique wagon identifier (e.g., FW-12345, HW-98765)" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Wagon Type *</label>
                                    <select name="wagon_type" class="form-select" required>
                                        <option value="" disabled selected>Select wagon type...</option>
                                        <option value="BOX">Box Wagon (General goods)</option>
                                        <option value="FLAT">Flat Wagon (Containers, vehicles)</option>
                                        <option value="HOPPER">Hopper Wagon (Coal, ore, grain)</option>
                                        <option value="TANK">Tank Wagon (Liquids, fuels)</option>
                                        <option value="REFRIGERATED">Refrigerated Wagon (Perishables)</option>
                                        <option value="AUTO_CARRIER">Auto Carrier (Cars, equipment)</option>
                                        <option value="TIPPLER">Tippler Wagon (Bulk minerals)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- General Dimensions -->
                    <div class="spec-section">
                        <h4>üìè General Dimensions</h4>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Length (over buffers) - meters</label>
                                    <input type="number" step="0.01" name="length_over_buffers" class="form-control" placeholder="Enter length between 10-25 meters">
                                    <small class="text-muted">Typical: 10-25m</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Width - meters</label>
                                    <input type="number" step="0.01" name="width" class="form-control" placeholder="Enter width between 2.8-3.2 meters">
                                    <small class="text-muted">Typical: 2.8-3.2m</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Height - meters</label>
                                    <input type="number" step="0.01" name="height" class="form-control" placeholder="Enter height between 3.8-4.2 meters">
                                    <small class="text-muted">Typical: 3.8-4.2m</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Track Gauge</label>
                                    <select name="track_gauge" class="form-select">
                                        <option value="1435">1,435 mm (Standard Gauge)</option>
                                        <option value="1067" selected>1,067 mm (Cape Gauge - South Africa)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Weight and Load Capacity -->
                    <div class="spec-section">
                        <h4>‚öñÔ∏è Weight and Load Capacity</h4>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Tare Weight (empty) - tonnes</label>
                                    <input type="number" step="0.01" name="tare_weight" class="form-control" placeholder="Enter empty weight (15-30 tonnes)">
                                    <small class="text-muted">Typical: 15-30t</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Payload Capacity - tonnes</label>
                                    <input type="number" step="0.01" name="payload_capacity" class="form-control" placeholder="Enter max cargo weight (40-80 tonnes)">
                                    <small class="text-muted">Typical: 40-80t</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Gross Laden Weight - tonnes</label>
                                    <input type="number" step="0.01" name="gross_laden_weight" class="form-control" placeholder="Enter total weight (60-100 tonnes)">
                                    <small class="text-muted">Tare + Payload: 60-100t</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Axle Load - tonnes/axle</label>
                                    <input type="number" step="0.01" name="axle_load" class="form-control" placeholder="Enter load per axle (16-25 tonnes)">
                                    <small class="text-muted">Typical: 16-25t/axle</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance and Operation -->
                    <div class="spec-section">
                        <h4>‚ö° Performance and Operation</h4>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Maximum Speed - km/h</label>
                                    <input type="number" name="maximum_speed" class="form-control" placeholder="Enter max speed (80-120 km/h)">
                                    <small class="text-muted">Typical: 80-120 km/h</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Braking System</label>
                                    <select name="braking_system" class="form-select">
                                        <option value="UIC" selected>UIC Standard Air Brake</option>
                                        <option value="AAR">AAR Standard Air Brake</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Coupling Type</label>
                                    <select name="coupling_type" class="form-select">
                                        <option value="AAR">AAR Knuckle Coupler</option>
                                        <option value="SA3" selected>SA3 Automatic Coupler</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Buffer/Drawgear Capacity - kN</label>
                                    <input type="number" name="buffer_drawgear_capacity" class="form-control" placeholder="Enter capacity (850-1000 kN)">
                                    <small class="text-muted">Typical: 850-1000 kN</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Material and Build -->
                    <div class="spec-section">
                        <h4>üîß Material and Build</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Body Material</label>
                                    <input type="text" name="body_material" class="form-control" placeholder="e.g., High-strength steel (Corten), Aluminum alloy">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Frame Construction</label>
                                    <input type="text" name="frame_construction" class="form-control" placeholder="e.g., Welded steel underframe, Reinforced for heavy loads">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Suspension System</label>
                                    <select name="suspension_system" class="form-select">
                                        <option value="COIL" selected>Coil Spring Bogies</option>
                                        <option value="LEAF">Leaf Spring Bogies</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Bogie Type</label>
                                    <select name="bogie_type" class="form-select">
                                        <option value="TWO_AXLE" selected>Two-Axle Bogies</option>
                                        <option value="FOUR_AXLE">Four-Axle Bogies</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Floor Type</label>
                                    <input type="text" name="floor_type" class="form-control" placeholder="e.g., Steel plate, Wooden deck, Composite flooring">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Type-Specific Features -->
                    <div class="spec-section">
                        <h4>‚ú® Type-Specific Features</h4>
                        <div class="mb-3">
                            <label class="form-label">Special Features</label>
                            <textarea name="special_features" class="form-control" rows="3" 
                                placeholder="Enter type-specific features (e.g., Bottom discharge gates for hoppers, Cooling unit for refrigerated wagons, Twist locks for container wagons, Safety valves for tank wagons, Rotatable mechanism for tippler wagons, Two-deck structure for auto carriers, Lockable doors for box wagons)"></textarea>
                            <small class="text-muted">
                                Examples: Box Wagon - lockable doors | Flat Wagon - twist locks | 
                                Hopper - discharge gates | Tank - safety valves | 
                                Refrigerated - cooling unit | Tippler - rotatable
                            </small>
                        </div>
                    </div>
    
          <div class="d-flex justify-content-end mt-4 gap-2">
            <button type="reset" class="btn btn-outline-secondary">Cancel</button>
            <button type="submit" class="btn btn-primary">Submit Wagon Specification</button>
          </div>
          </form>

          <!-- Question Builder inside same card -->
          <div class="builder mt-4">
            <h2>üìã Add Additional Specifications</h2>
            <p class="text-muted">Use this section to add any additional specifications not covered in the form above.</p>
            <div class="mb-3">
              <label class="form-label">Question Text:</label>
              <input class="form-control" type="text" id="questionText">
            </div>
            <div class="mb-3">
              <label class="form-label">Question Type:</label>
              <select class="form-select" id="questionType">
                <option value="text">Short Text</option>
                <option value="textarea">Long Text</option>
                <option value="radio">Multiple Choice (Single)</option>
                <option value="checkbox">Multiple Choice (Multiple)</option>
                <option value="dropdown">Dropdown</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Options (comma separated, for radio/checkbox/dropdown):</label>
              <input class="form-control" type="text" id="options">
            </div>
            <button class="btn btn-outline-dark" onclick="addQuestion()">Add Question</button>
          </div>
        </div>
    </div>
                
            </div>
        </div>
    </div>

  <script>
  let questionIndex = 0;
  const surveyPreview = document.getElementById("surveyPreviewInForm");
  const dynamicFields = document.getElementById("dynamicSurveyFields");

    // Function to parse survey_raw and recreate questions for editing
    function loadSurveyQuestions(surveyRaw) {
      if (!surveyRaw || surveyRaw.trim() === '') return;
      
      // Clear existing questions
      surveyPreview.innerHTML = '';
      dynamicFields.innerHTML = '';
      questionIndex = 0;
      
      const parts = surveyRaw.split(',');
      
      // Group every 3 parts: [text, type, answers]
      for (let i = 0; i < parts.length; i += 3) {
        if (i + 1 >= parts.length) break;
        
        const qtext = parts[i] || '';
        const qtype = parts[i + 1] || 'text';
        const answersStr = parts[i + 2] || '';
        
        if (!qtext.trim()) continue;
        
        let options = [];
        if (answersStr && (qtype === 'radio' || qtype === 'checkbox' || qtype === 'dropdown')) {
          options = answersStr.split(',').map(o => o.trim()).filter(o => o);
          if (options.length === 0) options = ['Option 1', 'Option 2'];
        }
        
        recreateQuestion(qtext, qtype, options, answersStr);
      }
    }
    
    // Helper function to recreate a question
    function recreateQuestion(text, type, options, answer) {
      const idx = questionIndex++;

      const previewWrapper = document.createElement("div");
      previewWrapper.className = 'd-flex align-items-center justify-content-between mb-2 p-2 border rounded';
      previewWrapper.id = `preview-${idx}`;
      
      const leftSection = document.createElement('div');
      leftSection.className = 'd-flex align-items-center';
      
      const previewLabel = document.createElement("strong");
      previewLabel.textContent = text;
      leftSection.appendChild(previewLabel);
      
      const typeBadge = document.createElement('span');
      typeBadge.className = 'badge bg-secondary ms-2';
      const typeMap = {
        text: 'Short Text',
        textarea: 'Long Text',
        radio: 'Multiple Choice (Single)',
        checkbox: 'Multiple Choice (Multiple)',
        dropdown: 'Dropdown'
      };
      typeBadge.textContent = typeMap[type] || type;
      leftSection.appendChild(typeBadge);
      
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn btn-sm btn-danger';
      removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
      removeBtn.addEventListener('click', () => {
        document.getElementById(`meta-${idx}`)?.remove();
        document.getElementById(`answer-${idx}`)?.remove();
        document.getElementById(`preview-${idx}`)?.remove();
      });
      
      previewWrapper.appendChild(leftSection);
      previewWrapper.appendChild(removeBtn);
      surveyPreview.appendChild(previewWrapper);

      const meta = document.createElement('input');
      meta.type = 'hidden';
      meta.name = 'survey_questions[]';
      meta.id = `meta-${idx}`;
      meta.value = JSON.stringify({ text: text, type: type, options: options });
      dynamicFields.appendChild(meta);

      const answerWrapper = document.createElement('div');
      answerWrapper.classList.add('form-group-row');
      answerWrapper.id = `answer-${idx}`;
      const answerLabel = document.createElement('label');
      answerLabel.textContent = text;
      answerWrapper.appendChild(answerLabel);

      if (type === 'text') {
        const a = document.createElement('input');
        a.type = 'text';
        a.name = `survey_answers[${idx}]`;
        a.className = 'form-control';
        a.value = answer || '';
        answerWrapper.appendChild(a);
      } else if (type === 'textarea') {
        const a = document.createElement('textarea');
        a.name = `survey_answers[${idx}]`;
        a.className = 'form-control';
        a.value = answer || '';
        answerWrapper.appendChild(a);
      } else if (type === 'radio') {
        const optsDiv = document.createElement('div');
        const answerValues = answer ? answer.split(',').map(v => v.trim()) : [];
        options.forEach(opt => {
          const r = document.createElement('input');
          r.type = 'radio';
          r.name = `survey_answers[${idx}]`;
          r.value = opt;
          r.className = 'me-1';
          if (answerValues.includes(opt)) r.checked = true;
          const lbl = document.createElement('label');
          lbl.className = 'me-3';
          lbl.appendChild(r);
          lbl.appendChild(document.createTextNode(opt));
          optsDiv.appendChild(lbl);
        });
        answerWrapper.appendChild(optsDiv);
      } else if (type === 'dropdown') {
        const sel = document.createElement('select');
        sel.name = `survey_answers[${idx}]`;
        sel.className = 'form-select';
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = '-- Select --';
        sel.appendChild(defaultOpt);
        options.forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          if (answer === opt) o.selected = true;
          sel.appendChild(o);
        });
        answerWrapper.appendChild(sel);
      } else if (type === 'checkbox') {
        const boxContainer = document.createElement('div');
        const answerValues = answer ? answer.split(',').map(v => v.trim()) : [];
        options.forEach(opt => {
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.name = `survey_answers[${idx}][]`;
          cb.value = opt;
          cb.className = 'me-1';
          if (answerValues.includes(opt)) cb.checked = true;
          const lbl = document.createElement('label');
          lbl.className = 'me-3';
          lbl.appendChild(cb);
          lbl.appendChild(document.createTextNode(opt));
          boxContainer.appendChild(lbl);
        });
        answerWrapper.appendChild(boxContainer);
      }

      dynamicFields.appendChild(answerWrapper);
    }

    function addQuestion() {
      const text = document.getElementById("questionText").value.trim();
      const type = document.getElementById("questionType").value;
      const options = document.getElementById("options").value.split(",").map(o => o.trim()).filter(o => o);

      if (!text) {
        alert("Please enter a question text");
        return;
      }

      const idx = questionIndex++;

      // Add compact preview in the form
      const previewWrapper = document.createElement("div");
      previewWrapper.classList.add("question");
      previewWrapper.id = `preview-${idx}`;
      const previewLabel = document.createElement("strong");
      previewLabel.textContent = text;
      previewWrapper.appendChild(previewLabel);
      const typeBadge = document.createElement('span');
      typeBadge.className = 'badge bg-secondary ms-2';
      const typeMap = {
        text: 'Short Text',
        textarea: 'Long Text',
        radio: 'Multiple Choice (Single)',
        checkbox: 'Multiple Choice (Multiple)',
        dropdown: 'Dropdown'
      };
      typeBadge.textContent = typeMap[type] || type;
      previewWrapper.appendChild(typeBadge);
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn btn-sm btn-outline-danger ms-2';
      removeBtn.textContent = 'Remove';
      removeBtn.addEventListener('click', () => {
        const metaEl = document.getElementById(`meta-${idx}`);
        const answerEl = document.getElementById(`answer-${idx}`);
        const previewEl = document.getElementById(`preview-${idx}`);
        if (metaEl) metaEl.remove();
        if (answerEl) answerEl.remove();
        if (previewEl) previewEl.remove();
      });
      previewWrapper.appendChild(removeBtn);
      surveyPreview.appendChild(previewWrapper);

      // Add metadata hidden input to wagon form: survey_questions[] (JSON)
      const meta = document.createElement('input');
      meta.type = 'hidden';
      meta.name = 'survey_questions[]';
      meta.id = `meta-${idx}`;
      meta.value = JSON.stringify({ text: text, type: type, options: options });
      dynamicFields.appendChild(meta);

      // Add visible answer input to wagon form with indexed names
      const answerWrapper = document.createElement('div');
      answerWrapper.classList.add('form-group-row', 'mb-3');
      answerWrapper.id = `answer-${idx}`;
      const answerLabel = document.createElement('label');
      answerLabel.className = 'form-label';
      answerLabel.textContent = text;
      answerWrapper.appendChild(answerLabel);

      if (type === 'text') {
        const a = document.createElement('input');
        a.type = 'text';
        a.name = `survey_answers[${idx}]`;
        a.className = 'form-control';
        answerWrapper.appendChild(a);
      } else if (type === 'textarea') {
        const a = document.createElement('textarea');
        a.name = `survey_answers[${idx}]`;
        a.className = 'form-control';
        answerWrapper.appendChild(a);
      } else if (type === 'radio') {
        const optsDiv = document.createElement('div');
        options.forEach(opt => {
          const r = document.createElement('input');
          r.type = 'radio';
          r.name = `survey_answers[${idx}]`;
          r.value = opt;
          r.className = 'me-1';
          const lbl = document.createElement('label');
          lbl.className = 'me-3';
          lbl.appendChild(r);
          lbl.appendChild(document.createTextNode(opt));
          optsDiv.appendChild(lbl);
        });
        answerWrapper.appendChild(optsDiv);
      } else if (type === 'dropdown') {
        const sel = document.createElement('select');
        sel.name = `survey_answers[${idx}]`;
        sel.className = 'form-select';
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = 'Select an option';
        sel.appendChild(defaultOpt);
        options.forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          sel.appendChild(o);
        });
        answerWrapper.appendChild(sel);
      } else if (type === 'checkbox') {
        const boxContainer = document.createElement('div');
        options.forEach(opt => {
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.name = `survey_answers[${idx}][]`;
          cb.value = opt;
          cb.className = 'me-1';
          const lbl = document.createElement('label');
          lbl.className = 'me-3';
          lbl.appendChild(cb);
          lbl.appendChild(document.createTextNode(opt));
          boxContainer.appendChild(lbl);
        });
        answerWrapper.appendChild(boxContainer);
      }

      dynamicFields.appendChild(answerWrapper);

      // Reset builder form
      document.getElementById("questionText").value = "";
      document.getElementById("options").value = "";
    }
  </script>
    <script>
      // Additional Specs Functions - Define early so they're available everywhere
      let additionalSpecCount = 0;
      
      function addAdditionalSpecField(label = '', value = '') {
        const container = document.getElementById('additionalSpecsContainer');
        const fieldGroup = document.createElement('div');
        fieldGroup.className = 'row mb-3 additional-spec-field';
        fieldGroup.id = `additional-spec-${additionalSpecCount}`;
        
        fieldGroup.innerHTML = `
          <div class="col-md-5">
            <input type="text" class="form-control" name="additional_label[]" placeholder="Field Label (e.g., 'Cargo Type')" value="${label}">
          </div>
          <div class="col-md-5">
            <input type="text" class="form-control" name="additional_value[]" placeholder="Field Value (e.g., 'Bulk Coal')" value="${value}">
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeAdditionalSpecField(${additionalSpecCount})">
              <i class="fas fa-trash"></i> Remove
            </button>
          </div>
        `;
        
        container.appendChild(fieldGroup);
        additionalSpecCount++;
      }
      
      function removeAdditionalSpecField(id) {
        const field = document.getElementById(`additional-spec-${id}`);
        if (field) {
          field.remove();
        }
      }
      
      function loadAdditionalSpecs(specs) {
        if (specs && Array.isArray(specs)) {
          specs.forEach(spec => {
            addAdditionalSpecField(spec.label || '', spec.value || '');
          });
        }
      }
      
      (function(){
        const sel = document.querySelector('select[name="wagon_select"]');
        const btn = document.getElementById('selectWagonBtn');
        if (!sel) return;
        const endpoint = "{% url 'api_get_wagon_spec' %}";
        function fetchSpecById(id){
          if (!id) return;
          
          // Clear existing survey questions first
          if (typeof surveyPreview !== 'undefined' && surveyPreview) surveyPreview.innerHTML = '';
          if (typeof dynamicFields !== 'undefined' && dynamicFields) dynamicFields.innerHTML = '';
          if (typeof questionIndex !== 'undefined') questionIndex = 0;
          
          fetch(endpoint + '?id=' + encodeURIComponent(id))
            .then(r => { if (r.status === 204) return null; return r.json(); })
            .then(data => {
              if (!data) return;
              const set = (n,v) => { const el = document.querySelector('[name="'+n+'"]'); if (el) el.value = v || ''; };
              const selIdEl = document.querySelector('[name="selected_spec_id"]'); if (selIdEl) selIdEl.value = data.id || '';
              set('wagon_number', data.wagon_number);
              set('wagon_type', data.wagon_type);
              set('length_over_buffers', data.length_over_buffers);
              set('width', data.width);
              set('height', data.height);
              set('track_gauge', data.track_gauge);
              set('tare_weight', data.tare_weight);
              set('payload_capacity', data.payload_capacity);
              set('gross_laden_weight', data.gross_laden_weight);
              set('axle_load', data.axle_load);
              set('maximum_speed', data.maximum_speed);
              set('braking_system', data.braking_system);
              set('coupling_type', data.coupling_type);
              set('buffer_drawgear_capacity', data.buffer_drawgear_capacity);
              set('body_material', data.body_material);
              set('frame_construction', data.frame_construction);
              set('suspension_system', data.suspension_system);
              set('bogie_type', data.bogie_type);
              set('floor_type', data.floor_type);
              set('special_features', data.special_features);
              
              // Load survey questions from survey_raw
              if (data.survey_raw) {
                loadSurveyQuestions(data.survey_raw);
              }
            }).catch(err => console.warn('wagon fetch', err));
        }
        sel.addEventListener('change', () => fetchSpecById(sel.value));
        if (btn) btn.addEventListener('click', () => fetchSpecById(sel.value));
      })();
    </script>

</div>
<!-- End of main content -->

<!-- All Wagons List Section -->
<div class="container-fluid px-3 mt-5 mb-5" style="max-width: 100%; overflow-x: hidden;">
  <div class="card shadow-sm">
    <div class="card-header" style="background: linear-gradient(135deg, #E31937 0%, #8B0000 100%);">
      <h4 class="text-white mb-0"><i class="fas fa-list"></i> All Wagons</h4>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
        <table class="table table-striped table-hover mb-0 table-sm">
          <thead class="sticky-top bg-light">
            <tr>
              <th style="min-width: 120px; width: 15%;">Wagon Number</th>
              <th style="min-width: 100px; width: 15%;">Type</th>
              <th style="min-width: 80px; width: 10%;">Tare Weight</th>
              <th style="min-width: 80px; width: 10%;">Payload Capacity</th>
              <th style="min-width: 80px; width: 10%;">Total Weight</th>
              <th style="min-width: 80px; width: 12%;">Status</th>
              <th style="min-width: 120px; width: 15%;">Actions</th>
            </tr>
          </thead>
        <tbody>
          {% for wagon in all_wagons %}
          <tr class="{% if wagon.status == 'WRITTEN_OFF' %}table-secondary{% endif %}">
            <td><strong>{{ wagon.wagon_number }}</strong></td>
            <td><span class="badge bg-info">{{ wagon.get_wagon_type_display }}</span></td>
            <td>{{ wagon.tare_weight|default:"N/A" }}t</td>
            <td>{{ wagon.payload_capacity|default:"N/A" }}t</td>
            <td>{{ wagon.gross_laden_weight|default:"N/A" }}t</td>
            <td>
              {% if wagon.status == 'WRITTEN_OFF' %}
                <span class="badge bg-secondary">Written Off</span>
              {% elif wagon.status == 'IN_USE' %}
                <span class="badge bg-success">In Use</span>
              {% elif wagon.status == 'IN_MAINTENANCE' %}
                <span class="badge bg-warning">In Maintenance</span>
              {% else %}
                <span class="badge bg-primary">{{ wagon.get_status_display }}</span>
              {% endif %}
            </td>
            <td>
              {% if wagon.status != 'WRITTEN_OFF' %}
                <form method="POST" action="{% url 'write_off_wagon' wagon.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to write off {{ wagon.wagon_number }}? This will mark it as no longer in use.');">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-warning" title="Write Off">
                    <i class="fas fa-ban"></i> Write Off
                  </button>
                </form>
              {% endif %}
              <form method="POST" action="{% url 'delete_wagon' wagon.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to PERMANENTLY DELETE {{ wagon.wagon_number }}? This cannot be undone!');">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </form>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center text-muted">No wagons found</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    {% endblock %}
