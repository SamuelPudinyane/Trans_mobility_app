{% extends 'base.html' %}

{% block title %}Train Tracker - South Africa{% endblock %}

{% block content %}

<div id="map" style="height: 600px;"></div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    var map = L.map("map").setView([-26.11938, 27.7490656], 14);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors"
    }).addTo(map);

    var userMarkers = {};
    var emergencyMarker = null;

    // Check if we need to highlight an emergency location
    {% if highlight_lat and highlight_lng %}
    var emergencyLat = {{ highlight_lat }};
    var emergencyLng = {{ highlight_lng }};
    var emergencyUser = "{{ highlight_user|escapejs }}";
    var emergencyIssue = "{{ highlight_issue|escapejs }}";
    
    // Create custom red icon for emergency marker
    var redIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    // Add emergency marker
    emergencyMarker = L.marker([emergencyLat, emergencyLng], {icon: redIcon})
        .addTo(map)
        .bindPopup(`
            <div style="min-width: 200px;">
                <h4 style="color: #E31937; margin: 0 0 10px 0;">
                    <i class="fas fa-exclamation-triangle"></i> Emergency Request
                </h4>
                <b>User:</b> ${emergencyUser}<br>
                <b>Issue:</b> ${emergencyIssue}<br>
                <b>Location:</b> ${emergencyLat.toFixed(4)}, ${emergencyLng.toFixed(4)}
            </div>
        `)
        .openPopup();
    
    // Center map on emergency location with closer zoom
    map.setView([emergencyLat, emergencyLng], 15);
    {% endif %}

    function loadLocations() {
        fetch("/api/update-location/")
            .then(res => res.json())
            .then(data => {
                data.forEach(item => {
                    let userId = item.user.id;
                    let popupContent = `
                        <b>${item.user.email}</b><br>
                        Role: ${item.user.role}<br>
                        Phone: ${item.user.phone || "N/A"}<br>
                        Last seen: ${item.timestamp}
                    `;

                    if (userMarkers[userId]) {
                        userMarkers[userId].setLatLng([item.lat, item.lng]);
                        userMarkers[userId].setPopupContent(popupContent);
                    } else {
                        userMarkers[userId] = L.marker([item.lat, item.lng])
                            .addTo(map)
                            .bindPopup(popupContent);
                    }
                });
            });
    }

    function sendLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                fetch("/api/update-location/", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        latitude: pos.coords.latitude,
                        longitude: pos.coords.longitude
                    })
                });
            });
        }
    }

    // Load map and markers
    loadLocations();
    setInterval(loadLocations, 10000);  // refresh markers every 10s
    setInterval(sendLocation, 5000);    // send user location every 5s
</script>

{% endblock %}
