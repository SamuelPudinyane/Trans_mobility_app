{% extends 'base.html' %}

{% block title %}Railway Tracker - South Africa{% endblock %}
{% block content %}

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    .map-container {
        padding: 20px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .map-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #E31937;
    }
    
    .map-header h1 {
        color: #333;
        margin: 0;
        font-size: 28px;
    }
    
    #map { 
        width: 100%; 
        height: 700px; 
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .info-box {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }
    
    .info-box i {
        color: #856404;
        margin-right: 8px;
    }
    
    .legend {
        background: white;
        padding: 15px;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        font-size: 13px;
        max-width: 250px;
    }
    
    .legend h4 {
        margin: 0 0 10px 0;
        font-size: 14px;
        font-weight: 700;
        color: #333;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .legend-icon {
        width: 20px;
        height: 20px;
        margin-right: 8px;
        border-radius: 3px;
    }
    
    .user-popup {
        min-width: 200px;
    }
    
    .user-popup h5 {
        margin: 0 0 10px 0;
        color: #E31937;
        font-size: 16px;
    }
    
    .user-popup p {
        margin: 5px 0;
        font-size: 13px;
    }
    
    /* Custom railway line styles */
    .railway-line {
        stroke: #444;
        stroke-width: 2;
        stroke-dasharray: 5, 5;
    }
    
    /* Status indicator */
    .status-indicator {
        position: absolute;
        top: 80px;
        right: 20px;
        background: white;
        padding: 10px 15px;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 1000;
        font-size: 13px;
    }
    
    .status-indicator.online {
        border-left: 4px solid #28a745;
    }
    
    .status-indicator.loading {
        border-left: 4px solid #ffc107;
    }
</style>

<div class="map-container">
    <div class="map-header">
        <h1><i class="fas fa-train"></i> Railway Tracker - Live Locations</h1>
    </div>
    
    <div class="info-box">
        <i class="fas fa-info-circle"></i>
        <strong>Railway Map:</strong> Track real-time locations of drivers and locomotives on South Africa's railway network. 
        Railway lines are shown in dark gray dashed lines. Click on markers for more information.
    </div>
    
    <div id="map"></div>
    <div id="status" class="status-indicator loading">
        <i class="fas fa-circle-notch fa-spin"></i> Loading map...
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Initialize map - centered on South Africa
        const map = L.map('map').setView([-28.5, 24.5], 6);
        
        // Update status
        const statusEl = document.getElementById('status');
        statusEl.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Loading tiles...';
        
        // Base map layer - OpenStreetMap
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18,
            opacity: 0.7
        });
        
        // Railway overlay layer - OpenRailwayMap
        const railwayLayer = L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openrailwaymap.org/">OpenRailwayMap</a>',
            maxZoom: 18,
            opacity: 1
        });
        
        // Alternative: Transport map with railways
        const transportLayer = L.tileLayer('https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=YOUR_API_KEY', {
            attribution: '&copy; Thunderforest',
            maxZoom: 18,
            opacity: 0.8
        });
        
        // Add base layer
        osmLayer.addTo(map);
        
        // Try to add railway layer with error handling
        let railwayLayerAdded = false;
        railwayLayer.on('tileerror', function(error, tile) {
            console.warn('Railway tile failed to load, using fallback');
            if (!railwayLayerAdded) {
                // If railway tiles fail, just use OSM with full opacity
                osmLayer.setOpacity(1);
            }
        });
        
        railwayLayer.on('tileload', function() {
            if (!railwayLayerAdded) {
                railwayLayerAdded = true;
                statusEl.innerHTML = '<i class="fas fa-check-circle" style="color: #28a745;"></i> Map ready';
                statusEl.className = 'status-indicator online';
            }
        });
        
        railwayLayer.addTo(map);
        
        // After 3 seconds, if no railway tiles loaded, show ready status anyway
        setTimeout(() => {
            if (!railwayLayerAdded) {
                statusEl.innerHTML = '<i class="fas fa-check-circle" style="color: #28a745;"></i> Map ready';
                statusEl.className = 'status-indicator online';
            }
        }, 3000);
        
        // Layer control
        const baseLayers = {
            "OpenStreetMap": osmLayer
        };
        
        const overlayLayers = {
            "Railway Lines": railwayLayer
        };
        
        L.control.layers(baseLayers, overlayLayers).addTo(map);
        
        // Add legend
        const legend = L.control({ position: 'bottomright' });
        
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <h4><i class="fas fa-train"></i> Legend</h4>
                <div class="legend-item">
                    <div class="legend-icon" style="background-color: #1976d2; border-radius: 50%;"></div>
                    <span>Your Location</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background-color: #E31937; border-radius: 50%;"></div>
                    <span>Driver Location</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background-color: #444; height: 2px; border-radius: 0;"></div>
                    <span>Railway Lines</span>
                </div>
            `;
            return div;
        };
        
        legend.addTo(map);
        
        // Store user markers
        const userMarkers = {};
        let myLocationMarker = null;
        
        // Custom icons
        const driverIcon = L.divIcon({
            html: '<div style="background-color: #E31937; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
            className: 'custom-marker',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });
        
        const myLocationIcon = L.divIcon({
            html: '<div style="background-color: #1976d2; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); animation: pulse 2s infinite;"></div><style>@keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; }}</style>',
            className: 'custom-marker',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });
        
        // Load user locations from server
        function loadLocations() {
            fetch('/api/update-location/')
                .then(response => response.json())
                .then(data => {
                    data.forEach(item => {
                        const userId = item.user.id;
                        const lat = item.lat;
                        const lng = item.lng;
                        
                        // Create popup content
                        const popupContent = `
                            <div class="user-popup">
                                <h5><i class="fas fa-user"></i> ${item.user.email}</h5>
                                <p><strong>Role:</strong> ${item.user.role}</p>
                                <p><strong>Phone:</strong> ${item.user.phone || 'N/A'}</p>
                                <p><strong>Last Updated:</strong> ${item.timestamp}</p>
                            </div>
                        `;
                        
                        if (userMarkers[userId]) {
                            // Update existing marker
                            userMarkers[userId].setLatLng([lat, lng]);
                            userMarkers[userId].setPopupContent(popupContent);
                        } else {
                            // Create new marker
                            const marker = L.marker([lat, lng], { icon: driverIcon })
                                .bindPopup(popupContent)
                                .addTo(map);
                            userMarkers[userId] = marker;
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading locations:', error);
                });
        }
        
        // Send current location to server
        function sendLocation() {
            if (!navigator.geolocation) {
                console.warn('Geolocation not supported');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Update or create "my location" marker
                    if (myLocationMarker) {
                        myLocationMarker.setLatLng([lat, lng]);
                    } else {
                        myLocationMarker = L.marker([lat, lng], { icon: myLocationIcon })
                            .bindPopup('<div class="user-popup"><h5>üìç Your Location</h5></div>')
                            .addTo(map);
                        
                        // Center map on user location on first load
                        map.setView([lat, lng], 12);
                    }
                    
                    // Send to server
                    fetch('/api/update-location/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            latitude: lat,
                            longitude: lng
                        })
                    }).catch(error => {
                        console.error('Error sending location:', error);
                    });
                },
                function(error) {
                    console.warn('Geolocation error:', error.message);
                }
            );
        }
        
        // Initialize
        loadLocations();
        sendLocation();
        
        // Refresh locations every 10 seconds
        setInterval(loadLocations, 10000);
        
        // Send location every 5 seconds
        setInterval(sendLocation, 5000);
        
        // Add scale control
        L.control.scale({ imperial: false, metric: true }).addTo(map);
        
        console.log('Railway map initialized successfully');
        
    } catch (error) {
        console.error('Error initializing map:', error);
        document.getElementById('map').innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: #666;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px; color: #E31937;"></i>
                <h3>Map Failed to Load</h3>
                <p>${error.message || 'Unknown error'}</p>
            </div>
        `;
    }
});
</script>

{% endblock %}