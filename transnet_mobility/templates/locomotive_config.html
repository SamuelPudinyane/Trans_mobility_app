{% extends 'base.html' %}

{% block title %}Locomotive Specifications{% endblock %}
{% block content %}
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    /* Keep the builder visually consistent with the main card/form
       Remove large external margins and let it use the same horizontal
       spacing as the rest of the page. */
   /* Rely on the Bootstrap grid for width and alignment so the builder lines
     up with the main card. Use a white background and card-like styling. */
   .builder, .survey { margin: 20px 0 0 0; padding: 15px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; background: #ffffff; }
   .builder { /* small visual lift and matching width; width is controlled by bootstrap columns */ }
    .question { margin: 10px 0; }
    label { display: block; margin-bottom: 5px; }
    input, select, button, textarea { margin: 5px 0; }
  </style>
        <!-- Main Content -->
        <div class=" p-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-4 text-center">Locomotive Specifications</h5>
            </div>
            <div class="card-body">
                <!-- Flash Messages -->
{% if messages %}
  <div class="container mt-3">
    {% for message in messages %}
      <div class="alert 
        {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} 
        alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

              <!-- Search Section -->
              <div class="filter-section">
                <div class="row align-items-center">
                  <div class="col-md-6">
                    <div class="input-group">
                      <select class="form-select" name="locomotive_select" required>
                        <option value="" selected disabled>Select locomotive...</option>
                        {% if locomotives %}
                          {% for l in locomotives %}
                            <option value="{{ l.id }}">{{ l.name }}</option>
                          {% endfor %}
                          <option disabled></option>
                        {% endif %}

                        </select>
                        <button id="selectLocoBtn" class="btn btn-primary" type="button">
                          Select
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <script>
                  // when select changes or the Select button is clicked, fetch spec and populate form
                  (function(){
                    const sel = document.querySelector('select[name="locomotive_select"]');
                    const btn = document.getElementById('selectLocoBtn');
                    if (!sel) return;

                    const endpoint = "{% url 'api_get_locomotive_spec' %}";

                    function fetchSpecById(id){
                        if (!id) return;
                        fetch(endpoint + '?id=' + encodeURIComponent(id))
                        .then(r => { if (r.status === 204) return null; return r.json(); })
                        .then(data => {
                          if (!data) return;
                          const set = (n,v) => { const el = document.querySelector("[name='"+n+"']"); if (el) el.value = v || ''; };
                          // set the hidden selected_spec_id so the form submits the id
                          const selIdEl = document.querySelector('[name="selected_spec_id"]');
                          if (selIdEl) selIdEl.value = data.id || '';
                          set('locomotive', data.locomotive);
                          set('loc_type', data.loc_type);
                          set('loc_class', data.loc_class);
                          set('engine_supply', data.engine_supply);
                          set('length', data.length);
                          set('capacity_in_tons', data.capacity_in_tons);
                          set('distributed_power', data.distributed_power);
                          set('tractive_effort', data.tractive_effort);
                          set('truck_circuit_spec', data.truck_circuit_spec);
                        }).catch(err => console.warn('spec fetch', err));
                    }
                    sel.addEventListener('change', () => fetchSpecById(sel.value));
                    if (btn) btn.addEventListener('click', () => fetchSpecById(sel.value));
                  })();
                </script>
                        
                      </select>
                      
                    </div>
                  </div>
                </div>
              </div>

              <!-- Form Section -->
              <div class="form-box">
                <form id="locomotiveForm" method="post" action="">
                  {% csrf_token %}
                  <input type="hidden" name="selected_spec_id" value="" />
                  
                  <div class="form-group-row">
                    <label>Locomotive Name</label>
                    <input
                      type="text"
                      name="locomotive"
                      class="form-control"
                      placeholder="name"
                    />
                  </div>
                  <div class="form-group-row">
                    <label>Type</label>
                    <input
                      type="text"
                      name="loc_type"
                      class="form-control"
                      placeholder="type"
                    />
                  </div>
                  <div class="form-group-row">
                    <label>Class</label>
                    <input
                      type="text"
                      name="loc_class"
                      class="form-control"
                      placeholder="class"
                    />
                  </div>
                  <div class="form-group-row">
                    <label>Engine Supply</label>
                    <input
                      type="text"
                      name="engine_supply"
                      class="form-control"
                      placeholder="engine supply"
                    />
                  </div>
                  <div class="form-group-row">
                    <label>Length</label>
                    <input
                      type="text"
                      name="length"
                      class="form-control"
                      placeholder="length"
                    />
                  </div>
                  <div class="form-group-row">
                    <label>Capacity In Tons</label>
                    <input
                      type="text"
                      name="capacity_in_tons"
                      class="form-control"
                      placeholder="capacity in tons"
                    />
                  </div>
                  <div class="form-group-row">
                    <label>Distributed Power</label>
                    <input
                      type="text"
                      name="distributed_power"
                      class="form-control"
                      placeholder="distributed power"
                    />
                  </div>
                  <div class="form-group-row">
                    <label>Tractive Efford</label>
                    <input
                      type="text"
                      name="tractive_effort"
                      class="form-control"
                      placeholder="tractive efford"
                    />
                  </div>
                  <div class="form-group-row">
                    <label>Truck Circuit Spec</label>
                    <input
                      type="text"
                      name="truck_circuit_spec"
                      class="form-control"
                      placeholder="track circuit spec"
                    />
                  </div>
                  <div id="dynamicSurveyFields"></div>
                  <!-- Survey preview (questions will be appended here) -->
                  <div id="surveyPreviewInForm" class="mb-3"></div>
                  <!-- Buttons -->
                  <div class="d-flex justify-content-end gap-2 mt-4">
                    <button type="reset" class="btn btn-outline-dark">
                      cancel
                    </button>
                    <button type="submit" class="btn btn-dark">submit</button>
                  </div>
                </form>

              <!-- Question Builder moved inside the same card so it shares width -->
              <div class="builder mt-4">
                <h2 class="card-title">Add Section</h2>
                <div class="mb-3">
                  <label class="form-label">Question Text:</label>
                  <input class="form-control" type="text" id="questionText">
                </div>
                <div class="mb-3">
                  <label class="form-label">Question Type:</label>
                  <select class="form-select" id="questionType">
                    <option value="text">Short Text</option>
                    <option value="textarea">Long Text</option>
                    <option value="radio">Multiple Choice (Single)</option>
                    <option value="checkbox">Multiple Choice (Multiple)</option>
                    <option value="dropdown">Dropdown</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Options (comma separated, for radio/checkbox/dropdown):</label>
                  <input class="form-control" type="text" id="options">
                </div>
                <button class="btn btn-outline-dark" onclick="addQuestion()">Add Question</button>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

  <!-- Survey Display -->
  <!-- survey preview moved into the locomotive form above -->

 <script>
  let questionIndex = 0;
  const surveyPreview = document.getElementById("surveyPreviewInForm");
  const dynamicFields = document.getElementById("dynamicSurveyFields");

    function addQuestion() {
      const text = document.getElementById("questionText").value.trim();
      const type = document.getElementById("questionType").value;
      const options = document.getElementById("options").value.split(",").map(o => o.trim()).filter(o => o);

      if (!text) {
        alert("Please enter a question text");
        return;
      }

      const idx = questionIndex++;

      // Add compact preview in the Survey area (no form controls to avoid duplicates)
      const previewWrapper = document.createElement("div");
      previewWrapper.classList.add("question");
      previewWrapper.id = `preview-${idx}`;
      const previewLabel = document.createElement("strong");
      previewLabel.textContent = text;
      previewWrapper.appendChild(previewLabel);
      const typeBadge = document.createElement('span');
      typeBadge.className = 'badge bg-secondary ms-2';
      const typeMap = {
        text: 'Short Text',
        textarea: 'Long Text',
        radio: 'Multiple Choice (Single)',
        checkbox: 'Multiple Choice (Multiple)',
        dropdown: 'Dropdown'
      };
      typeBadge.textContent = typeMap[type] || type;
      previewWrapper.appendChild(typeBadge);
      // remove button
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn btn-sm btn-outline-danger ms-2';
      removeBtn.textContent = 'Remove';
      removeBtn.addEventListener('click', () => {
        const metaEl = document.getElementById(`meta-${idx}`);
        const answerEl = document.getElementById(`answer-${idx}`);
        const previewEl = document.getElementById(`preview-${idx}`);
        if (metaEl) metaEl.remove();
        if (answerEl) answerEl.remove();
        if (previewEl) previewEl.remove();
      });
      previewWrapper.appendChild(removeBtn);
      surveyPreview.appendChild(previewWrapper);

      // Add metadata hidden input to locomotive form: survey_questions[] (JSON)
  const meta = document.createElement('input');
      meta.type = 'hidden';
  meta.name = 'survey_questions[]';
  meta.id = `meta-${idx}`;
      meta.value = JSON.stringify({ text: text, type: type, options: options });
      dynamicFields.appendChild(meta);

      // Add visible answer input to locomotive form with indexed names
  const answerWrapper = document.createElement('div');
      answerWrapper.classList.add('form-group-row');
  answerWrapper.id = `answer-${idx}`;
      const answerLabel = document.createElement('label');
      answerLabel.textContent = text;
      answerWrapper.appendChild(answerLabel);

      if (type === 'text') {
        const a = document.createElement('input');
        a.type = 'text';
        a.name = `survey_answers[${idx}]`;
        a.className = 'form-control';
        answerWrapper.appendChild(a);
      } else if (type === 'textarea') {
        const a = document.createElement('textarea');
        a.name = `survey_answers[${idx}]`;
        a.className = 'form-control';
        answerWrapper.appendChild(a);
      } else if (type === 'radio') {
        const optsDiv = document.createElement('div');
        options.forEach(opt => {
          const r = document.createElement('input');
          r.type = 'radio';
          r.name = `survey_answers[${idx}]`;
          r.value = opt;
          r.className = 'me-1';
          const lbl = document.createElement('label');
          lbl.className = 'me-3';
          lbl.appendChild(r);
          lbl.appendChild(document.createTextNode(opt));
          optsDiv.appendChild(lbl);
        });
        answerWrapper.appendChild(optsDiv);
      } else if (type === 'dropdown') {
        const sel = document.createElement('select');
        sel.name = `survey_answers[${idx}]`;
        sel.className = 'form-select';
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = 'Select an option';
        sel.appendChild(defaultOpt);
        options.forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          sel.appendChild(o);
        });
        answerWrapper.appendChild(sel);
      } else if (type === 'checkbox') {
        // For checkbox we create multiple checkbox inputs with name survey_answers[IDX][] so getlist works server-side
        const boxContainer = document.createElement('div');
        options.forEach(opt => {
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.name = `survey_answers[${idx}][]`;
          cb.value = opt;
          cb.className = 'me-1';
          const lbl = document.createElement('label');
          lbl.className = 'me-3';
          lbl.appendChild(cb);
          lbl.appendChild(document.createTextNode(opt));
          boxContainer.appendChild(lbl);
        });
        answerWrapper.appendChild(boxContainer);
      }

      dynamicFields.appendChild(answerWrapper);

      // Reset builder form
      document.getElementById("questionText").value = "";
      document.getElementById("options").value = "";
    }
  </script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Optional Bootstrap icons if you use <i> tags -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    {% endblock %}
