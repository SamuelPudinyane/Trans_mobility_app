{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <h2 class="mb-4"><i class="fas fa-brain"></i> Optimization Dashboard</h2>
    
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-primary">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Total Requests</h6>
                    <h3 class="card-title mb-0">{{ stats.total_requests }}</h3>
                    <small class="text-muted"><i class="fas fa-paper-plane"></i> All optimization requests</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-warning">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Processing</h6>
                    <h3 class="card-title mb-0 text-warning">{{ stats.processing_requests }}</h3>
                    <small class="text-muted"><i class="fas fa-spinner"></i> Currently processing</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-info">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Pending Review</h6>
                    <h3 class="card-title mb-0 text-info">{{ stats.pending_suggestions }}</h3>
                    <small class="text-muted"><i class="fas fa-clock"></i> Awaiting admin review</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-success">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Implemented</h6>
                    <h3 class="card-title mb-0 text-success">{{ stats.implemented_suggestions }}</h3>
                    <small class="text-muted"><i class="fas fa-check"></i> Successfully implemented</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Optimization Button -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-rocket"></i> Request New Optimization</h5>
                </div>
                <div class="card-body">
                    <form id="optimizationForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="optimizationType" class="form-label">Optimization Type</label>
                                <select class="form-select" id="optimizationType" required>
                                    <option value="">Select optimization type...</option>
                                    <option value="ROUTE_OPTIMIZATION">Route Optimization</option>
                                    <option value="LOAD_BALANCING">Load Balancing</option>
                                    <option value="FUEL_EFFICIENCY">Fuel Efficiency</option>
                                    <option value="MAINTENANCE_SCHEDULING">Maintenance Scheduling</option>
                                    <option value="WAGON_ALLOCATION">Wagon Allocation</option>
                                    <option value="LOCOMOTIVE_ASSIGNMENT">Locomotive Assignment</option>
                                    <option value="FULL_SYSTEM">Full System Optimization</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-paper-plane"></i> Submit Optimization Request
                                </button>
                            </div>
                        </div>
                    </form>
                    <div id="requestStatus" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- High Priority Suggestions -->
    {% if high_priority %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> High Priority Suggestions</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for suggestion in high_priority %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ suggestion.title }}</h6>
                                    <p class="mb-1 text-muted">{{ suggestion.description|truncatewords:30 }}</p>
                                    <small class="text-muted">
                                        <span class="badge bg-danger">{{ suggestion.priority }}</span>
                                        <span class="badge bg-secondary">{{ suggestion.suggestion_type }}</span>
                                        <span class="badge bg-info">{{ suggestion.implementation_status }}</span>
                                    </small>
                                </div>
                                <div class="btn-group ms-3">
                                    <button class="btn btn-sm btn-success" onclick="updateSuggestionStatus({{ suggestion.id }}, 'APPROVED')">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button class="btn btn-sm btn-info" onclick="viewSuggestionDetails({{ suggestion.id }})">
                                        <i class="fas fa-eye"></i> Details
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Pending Suggestions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Pending Suggestions</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Type</th>
                                    <th>Priority</th>
                                    <th>Expected Improvement</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for suggestion in pending_suggestions %}
                                <tr>
                                    <td>{{ suggestion.title }}</td>
                                    <td><span class="badge bg-secondary">{{ suggestion.suggestion_type }}</span></td>
                                    <td>
                                        {% if suggestion.priority == 'CRITICAL' %}
                                            <span class="badge bg-danger">{{ suggestion.priority }}</span>
                                        {% elif suggestion.priority == 'HIGH' %}
                                            <span class="badge bg-warning">{{ suggestion.priority }}</span>
                                        {% else %}
                                            <span class="badge bg-info">{{ suggestion.priority }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if suggestion.expected_improvement %}
                                            {{ suggestion.expected_improvement|truncatechars:50 }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-warning">{{ suggestion.implementation_status }}</span></td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-success" onclick="updateSuggestionStatus({{ suggestion.id }}, 'APPROVED')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-danger" onclick="updateSuggestionStatus({{ suggestion.id }}, 'REJECTED')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button class="btn btn-primary" onclick="updateSuggestionStatus({{ suggestion.id }}, 'IMPLEMENTED')">
                                                <i class="fas fa-cog"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No pending suggestions</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Optimization Requests -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Recent Optimization Requests</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Request ID</th>
                                    <th>Type</th>
                                    <th>Requested By</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Processed</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for request in recent_requests %}
                                <tr>
                                    <td><code>{{ request.request_id|truncatechars:20 }}</code></td>
                                    <td><span class="badge bg-secondary">{{ request.optimization_type }}</span></td>
                                    <td>{{ request.requested_by.email }}</td>
                                    <td>
                                        {% if request.status == 'COMPLETED' %}
                                            <span class="badge bg-success">{{ request.status }}</span>
                                        {% elif request.status == 'PROCESSING' %}
                                            <span class="badge bg-warning">{{ request.status }}</span>
                                        {% elif request.status == 'FAILED' %}
                                            <span class="badge bg-danger">{{ request.status }}</span>
                                        {% else %}
                                            <span class="badge bg-info">{{ request.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ request.created_at|date:"Y-m-d H:i" }}</td>
                                    <td>{{ request.processed_at|date:"Y-m-d H:i"|default:"N/A" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No recent requests</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Suggestion Details Modal -->
<div class="modal fade" id="suggestionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Suggestion Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="suggestionDetails">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Submit optimization request
document.getElementById('optimizationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const optimizationType = document.getElementById('optimizationType').value;
    const statusDiv = document.getElementById('requestStatus');
    
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Submitting request...</div>';
    
    fetch('/api/optimizer/request/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            optimization_type: optimizationType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> ${data.message}
                    <br><small>Request ID: ${data.request_id}</small>
                </div>
            `;
            setTimeout(() => location.reload(), 2000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> ${data.error}</div>`;
        }
    })
    .catch(error => {
        statusDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Error: ${error.message}</div>`;
    });
});

// Update suggestion status
function updateSuggestionStatus(suggestionId, status) {
    if (!confirm(`Are you sure you want to mark this suggestion as ${status}?`)) {
        return;
    }
    
    const notes = prompt('Enter review notes (optional):');
    
    fetch(`/api/optimizer/suggestions/${suggestionId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            status: status,
            notes: notes || ''
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Suggestion status updated successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

// View suggestion details
function viewSuggestionDetails(suggestionId) {
    fetch(`/api/optimizer/suggestions/?suggestion_id=${suggestionId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success && data.suggestions.length > 0) {
            const suggestion = data.suggestions[0];
            const detailsHtml = `
                <h6>${suggestion.title}</h6>
                <p>${suggestion.description}</p>
                <hr>
                <h6>Expected Improvements:</h6>
                <pre>${JSON.stringify(suggestion.expected_improvement, null, 2)}</pre>
                <h6>Current Metrics:</h6>
                <pre>${JSON.stringify(suggestion.current_metrics, null, 2)}</pre>
                <h6>Projected Metrics:</h6>
                <pre>${JSON.stringify(suggestion.projected_metrics, null, 2)}</pre>
                <h6>Implementation Steps:</h6>
                <pre>${JSON.stringify(suggestion.implementation_steps, null, 2)}</pre>
            `;
            document.getElementById('suggestionDetails').innerHTML = detailsHtml;
            new bootstrap.Modal(document.getElementById('suggestionModal')).show();
        }
    });
}
</script>

<style>
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.list-group-item {
    border-left: 4px solid #dc3545;
}

pre {
    background-color: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    max-height: 300px;
    overflow-y: auto;
}
</style>
{% endblock %}
